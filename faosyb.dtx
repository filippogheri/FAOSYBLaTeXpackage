% \iffalse
%<*gobble>
%
% Copyright 2013--2014, FAO UN
%
%
% \fi 
% \CheckSum{2719}
%
%
%% \CharacterTable
%%  {Upper-case    \A\B\C\D\E\F\G\H\I\J\K\L\M\N\O\P\Q\R\S\T\U\V\W\X\Y\Z
%%   Lower-case    \a\b\c\d\e\f\g\h\i\j\k\l\m\n\o\p\q\r\s\t\u\v\w\x\y\z
%%   Digits        \0\1\2\3\4\5\6\7\8\9
%%   Exclamation   \!     Double quote  \"     Hash (number) \#
%%   Dollar        \$     Percent       \%     Ampersand     \&
%%   Acute accent  \'     Left paren    \(     Right paren   \)
%%   Asterisk      \*     Plus          \+     Comma         \,
%%   Minus         \-     Point         \.     Solidus       \/
%%   Colon         \:     Semicolon     \;     Less than     \<
%%   Equals        \=     Greater than  \>     Question mark \?
%%   Commercial at \@     Left bracket  \[     Backslash     \\
%%   Right bracket \]     Circumflex    \^     Underscore    \_
%%   Grave accent  \`     Left brace    \{     Vertical bar  \|
%%   Right brace   \}     Tilde         \~} 
%
% \iffalse
%
%\section{Identification}
%\label{sec:ident}
%
% We start with the declaration who we are
%    \begin{macrocode}
%</gobble>
%<class>\NeedsTeXFormat{LaTeX2e}
%<*gobble>
\ProvidesFile{faosyb.dtx}
%</gobble>
%<class>\ProvidesClass{faosyb}
[2014/04/06 v1.7 Typesetting FAO Yearbook]
%<*gobble>
%    \end{macrocode}
%
%
% \fi
%
%\iffalse
%    \begin{macrocode}
\documentclass{ltxdoc}
\usepackage{array,graphpap}
\usepackage{hypdoc}
\PageIndex
\CodelineIndex
\RecordChanges
\EnableCrossrefs
\begin{document}
  \DocInput{faosyb.dtx}
\end{document}
%    \end{macrocode}
%</gobble> 
%<*class>
% \fi
% \MakeShortVerb{|}
% \GetFileInfo{faosyb.dtx}
% \newcommand{\progname}[1]{\textsf{#1}}
% \title{New \LaTeX{} Style for FAO Yearbook
%   \thanks{\copyright 2013, Food and Agriculture Organization of the
%   United Nations}} 
% \author{Boris Veytsman\thanks{%
% \href{mailto:borisv@lk.net}{\texttt{borisv@lk.net}},
% \href{mailto:boris@varphi.com}{\texttt{boris@varphi.com}}}} 
% \date{\filedate, \fileversion}
% \maketitle
% \begin{abstract}
%   This package provides class for typesetting FAO Yearbook.  This is
%   a refactoring of the \progname{faoyeabook} package
% \end{abstract}
%
%
%\section{Introduction}
%\label{sec:intro}
%
% The package \progname{faoyearbook}~\cite{faoyearbook11} was written
% in 2011 for FAO Statistical Yearbook.
%
% The package \progname{faosyb} is a refactoring of this package.  We
% use the lessons learned and incorporate new design requirements.  We
% use some (actually plenty) code from the previous version, but since
% we do not have to be compatibility, we can correct some unfortunate
% decisions.  
%
%\section{User Guide}
%\label{sec:user_guide}
%
% The installation of the class follows the usual
% practice~\cite{TeXFAQ} for \LaTeX{} packages:
% \begin{enumerate}
% \item Run \progname{latex} on |faosyb.ins|.  This will produce the
% \LaTeX{} class |faosyb.cls|.
% \item Put the file |faosyb.cls| to the place where \LaTeX{} can
%   find it (see \cite{TeXFAQ} or the documentation for your \TeX{}
%   system).\label{item:install}
% \item Update the database of file names.  Again, see \cite{TeXFAQ}
% or the documentation for your \TeX{} system for the system-specific
% details.\label{item:update}
% \item The file |faosyb.pdf| provides the documentation for the
% package (this is the file you are probably reading now).
% \end{enumerate}
% As an alternative to items~\ref{item:install} and~\ref{item:update}
% you can just put the file |faosyb.cls| in the working directory
% where your |.tex| file is.
%
%\subsection{Invocation}
%\label{sec:ug_invocation}
%
% To use the class, put in the preamble of your document
% \begin{flushleft}
% |\documentclass[|\meta{options}|]{faosyb}|
% \end{flushleft}
%
% If the option |web| is chosen, the pages of the book have
% the dimensions corresponding to A4 paper.  However, if the option
% |print| is chosen, then the pages are printed on a wider area, and
% crop marks are added for the trimming.  Either |web| or |print|
% option must be chosen: there is no default.
%
% If the option |issuu| is chosen, the internal links are transformed
% to external in the form suitable for \url{http://www.issuu.com}.
% Note that this option probably does not make much sense unless |web|
% option is also chosen.  However, it is still possible to select both
% |print| and |issuu| option if someone needs it for an obscure
% purpose.  
%
%
%
% The option |Draft| (note the capitalization!) leads to the the large
% word `DRAFT' printed across the pages.  The standard \LaTeX{} option
% |draft| leads to the same result, but it also makes other changes,
% most notably, in the behavior of the |\includegraphics| command and
% warnings.  
%
% \DescribeMacro{\ifprint}
% It is possible to query the current mode using the macro
% \cmd{\ifprint}, for example
% \begin{verbatim}
% \ifprint
%   Stuff for print version
% \else
%   Stuff for web version
% \fi
% \end{verbatim}
% Any branch of this conditional may be empty, so web-only stuff can
% be coded as
% \begin{verbatim}
% \ifprint\else Web-only stuff\fi
% \end{verbatim}
% 
%
% \DescribeMacro{\includegraphics}
% There is a special facilty for \cmd{\includegraphics} command to
% choose a file depending on the current mode of the package.  Namely,
% if there is a file |image_print.pdf| visible by \LaTeX, then the commands
% |\includegraphics{image}| or  |\includegraphics{image.pdf}| selects
% the file |image_print.pdf|.  In the case this file is not found, the
% file |image.pdf| is selected instead.  Similarly in the web mode the
% file |image_web.pdf| will be selected first, and only if it does not
% exist, |image.pdf| is selected.  This rule works also for commands
% \cmd{\includeLargeGraphics} and \cmd{\includeExtraLargeGraphics}
% described below.
%
% Note that at this time there is no
% similar facility for the |\input| command.  
%
% 
%
%\subsection{Setting Parameters}
%\label{sec:ug_faoset}
%
% \DescribeMacro{\faoset}
% Some parameters in the class can be set with the command
% |\faoset|\marg{key=value}, for example
% \begin{verbatim}
% \faoset{bgcolor=blue}
% \end{verbatim}
% 
%
%  Most of the parameters are explained below.
%
%  One of the important parameters is |year|.  While the package at
%  this time does not provide facilities for the title pages, it needs
%  to know the year for the proper typesetting of footers.  The
%  command
% \begin{verbatim}
% \faoset{year=2013}
% \end{verbatim}
%  is used to provide this information.  
%
%\subsection{Fonts}
%\label{sec:ug_fonts}
%
%\DescribeMacro{\narrowfamily}
%\DescribeMacro{\textnarrow}
%\DescribeMacro{\captionfamily}
%\DescribeMacro{\textcaption}
% The class uses PT Sans fonts~\cite{Farar:ParaType} for body text and
% Arev fonts~\cite{Hartke:ArevSans} for math.  It defines two
% additional families: Narrow and Caption, corresponding to the PT
% Sans Narrow and PT Sans Caption font.  They can be selected by the
% declarations \cmd{\narrowfamily} and \cmd{\captionfamily} or by the
% commands \cmd{\textnarrow}\marg{text} and
% \cmd{\textcaption}\marg{text} following the usual \LaTeX{}
% conventions.  Note that since PT Sans does not provide math
% alphabet, this choice does not change the mathematical text.
%
% PT Sans Narrow may be useful for typesetting tables, for example,
% \begin{verbatim}
%  {\scriptsize\narrowfamily
%  \rowcolors{4}{@bgcolor!30}{@bgcolor!20}
%  \input{./Tables/P1.DEM_1.tex}}
% \end{verbatim}
%  The choice of \cs{narrowfamily} is automatically done by the
%  |tablepages| environment.
%
%\subsection{Colors and Icons for Parts}
%\label{sec:ug_color_icons}
%
% A Yearbook is separated into parts (more on this below).  Each part
% has its own color and icon.  They are set by the keys |bgcolor| and
% |icon| of the \cs{faoset} command, for example,
% \begin{verbatim}
% \faoset{icon=./Icons/agriculture.png}
% \faoset{icon=./Icons/population}
% \faoset{bgcolor=blue}
% \faoset{bgcolor=green!25!yellow}
% \end{verbatim}
% The parameter for the |icon| key can be any file name (with or
% without extension), suitable for the \cs{includegraphics} command.
% The parameter for the |bgcolor| key can be specified in any form
% acceptable by \progname{xcolor} package~\cite{Kern07:Xcolor}.  
%
% The key |tableheadcolor| sets the color for the headers of tables defined
% by |H| or |P| key (see Section~\ref{sec:ug_floats}).  Normally it is
% the current |@bgcolor| color, but it can be set to any required
% value. 
%
% \DescribeMacro{\selecticon}\DescribeMacro{\selectcolor}
% Note that \cs{faoset} command does not change the icon or background
% color immediately.  When issued \emph{before} \cs{part} command, it
% sets up icon and color for the next part.  If needed, you can
% manually change this using \cs{selecticon} and \cs{selectcolor}
% commands.  In most cases you should \emph{not} use these commands.  
%
% \DescribeMacro{@bgcolor}
% \DescribeMacro{@tableheadcolor}
% \DescribeMacro{\currenticon}
% After a \cs{part} command (or explicit \cs{selecticon} and
% \cs{selectcolor} command we can access the current values of the
% color in |@bgcolor|, |@tablecolor| colors and \cs{currenticon}
% macro.  
%
% Foreword and other parts in the front matter of the book do not use
% icons.  Instead they have geometric symbols.  The key |symbol| can
% have the values |rigthttriangle|, |square|, |rightsemicircle| and
% sets the symbol for such part.
%
% \DescribeMacro{\lettrine}
% Front matter uses dropped capitals (lettrines) in the beginning of
% the sections. 
% The command |\lettrine{W}{ord}| can help in this case. 
%
%\subsection{Sectioning}
%\label{sec:ug_sections}
%
% \DescribeMacro{\part} 
% \DescribeMacro{\section} 
% \DescribeMacro{\subsection} 
%  The main division of the text are |\part|s.
%  The command \cmd{\part}\marg{title} is used for numbered parts, while the
%  command \cmd{\part*}\marg{title} is used for unnumbered parts.  The
%  next division are |\section|s and 
% |\subsection|s.  They are never numbered.  The style does not use
% |\chapter|s. 
%
% \DescribeMacro{\EndPartIntro}
% The sections immediately following new parts are special:  they are
% typeset in one column and cannot have floats.  The command
% |\EndPartIntro| switches to the ``normal'' sections.  
%
%
%\subsection{Headers and Footers}
%\label{sec:ug_footers}
%
% \DescribeMacro{\evenfootmark}
% \DescribeMacro{\oddfootmark}
% Normally headers and footers are defined by the text.  However,
% there is a possibility to change some of them.  Commands
% \cs{evenfootmark}\marg{text} and \cs{oddfootmark} set the right and
% left footers for even and odd pages correspondingly (the remaining
% footers are used by the page numbers).  By default they are defined as
% \begin{verbatim}
% \evenfootmark{\textbf{FAO} Statistical Yearbook \textbf{\fao@year}}
% \oddfootmark{\rightmark}
% \end{verbatim}
% The last command sets the footer to be the current section name (or
% part name before the first section), but the user can change this.  
%
%
%\subsection{Floats}
%\label{sec:ug_floats}
%
% One of the most important changes from the previous version of the
% class~\cite{faoyearbook11} is the treatment of floats.
%
% In standard \LaTeX\ floats ``float'': they can be placed by the
% algorithm anywhere.  The previous version made them ``sticky'':  the
% author explicitly tells \TeX\ where floats should be placed.
% However, to do so the class required the author to make explicity
% page breaks, which was not very convenient.
%
% This version has a completely rewritten interface and algorithm for
% placing floats:
% \begin{enumerate}
% \item Like in standard \LaTeX, authors do not normally provide page
% breaks---\TeX\ tries to make this decision for them.
% \item Like in the previous version, floats are put exactly where the
% authors want them---no default placing and second-guessing.
% \end{enumerate}
% 
% Here is how it is done.  
%
% The main unit of the book is \emph{spread:} a verso page and the
% corresponding recto page.  Each page is divided into four quarters,
% upper left, upper right, lower left and lower right.  We will denote
% them \texttt{ul}, \texttt{ur}, \texttt{ll}, \texttt{lr} for the
% verso page and \texttt{UL}, \texttt{UR}, \texttt{LL}, \texttt{LR}
% for the recto page (Figure~\ref{fig:spread}).  We allow four kinds
% of floats:
% \begin{description}
% \item[Single floats] occupy exactly one quarter.  They are denoted as
% \texttt{S}.
% \item[Tall floats] occupy two quarters stacked vertically
% (for example, \texttt{ul} and \texttt{ll}).  They are denoted as
% \texttt{T}.
% \item[Wide floats] occupy two quarters adjacent horizontally (for
% example, \texttt{LL} and \texttt{LR}).  They are denoted as
% \texttt{W}.
% \item[Big floats] occupy all four quarters on a page.  They are
% denoted as \texttt{B}.  
% \end{description}
% 
%
%
% \begin{figure}
%   \centering
%   \begin{picture}(350,250)
%     \put(0,150){\framebox(75,100){ul}}
%     \put(75,150){\framebox(75,100){ur}}
%     \put(0,50){\framebox(75,100){ll}}
%     \put(75,50){\framebox(75,100){lr}}
%     \put(50,25){Verso page}
%     \put(200,150){\framebox(75,100){UL}}
%     \put(275,150){\framebox(75,100){UR}}
%     \put(200,50){\framebox(75,100){LL}}
%     \put(275,50){\framebox(75,100){LR}}
%     \put(250,25){Recto page}
%   \end{picture}
%   \caption{A Spread}
%   \label{fig:spread}
% \end{figure}
% 
% The parameters \marg{type} and \marg{location} are mandatory for
% floats, for example
% \begin{verbatim}
% \begin{map}{T}{ur}
%   ...
% \end{map}
% \begin{chart}{S}{UL}
%   ...
% \end{chart}
% \end{verbatim}
% For multiquarter floats the location is the location of the upper
% left corner, so Big float can use only |ul| or |UL| location.
%
% Of course, not all combinations are valid:  you cannot specify float
% as |{T}{ll}| or |{W}{UR}|, for example.  If you use such
% combinations, the results may be unpredictable.  Also it is not
% predictable what happens if you try to put overlapping floats
% (e.g. |{S}{UR}| and |{W}{UL}|).  
%
% There are two additional rules:
% \begin{enumerate}
% \item A verso page may have text and floats (still it is
% recommended that if it has text, then it should not have floats
% occupying the upper left corner).
% \item A recto page may have \emph{either} text \texttt{or} floats:
% if there are floats for this page, all text is moved to the
% following verso page.  
% \end{enumerate}
%  
% There are three
% types of floats defined by the class:
% \DescribeEnv{chart}
% \DescribeEnv{map}
% \DescribeEnv{table}
% \begin{description}
% \item[chart] plots and other charts,
% \item[map] mapped data.
% \item[table] mini tables.
% \end{description}
% \DescribeMacro{caption}
% Each of these kinds of material is typeset using the corresponding
% environment: |chart|, |table| or |map|.  Note that the caption for
% each of these environments \emph{must} precede the graphical
% material, for example:
% \begin{verbatim}
% \begin{chart}{B}{UL}
%   \caption{Hunger Data}
%   \label{chart:hunger}
%   \includegraphics{hunger.pdf}
% \end{chart}
% \end{verbatim}
% Note that our class redefines |table| environemnt!.  For tables on
% separate pages use |longtable|.
%
% \DescribeMacro{\chartwidth}
% \DescribeMacro{\chartheight}
% Inside a |chart|, |map| or |table| it is useful to know the size
% allocated for the graphics or table, for example, to be able to
% scale the graphics.  Two lengths, \cs{chartwidth} and
% \cs{chartheight} provide this information, so the user can say, for
% example,
% \begin{verbatim}
% \includegraphics[width=\chartwidth, height=\chartheight]{theChart}
% \end{verbatim}
% 
% \DescribeMacro{\source}
% Inside a a |chart|, |map| or |table| the macro
% \cs{source}\marg{source} gives the source of the information, for
% example,
% \begin{verbatim}
% \Source{FAO, Statistical Division [FAOSTAT]}
% \end{verbatim}
% 
%
% \DescribeMacro{\listoftables}
% \DescribeMacro{\listofcharts}
% \DescribeMacro{\listofmaps}
% The standard \LaTeX{} has the command |\listoftables| to produce the
% list of tables in the document.  Our class retains this command and
% produces two additional commands |\listofcharts| and |\listofmaps|
% with the obvious meaning.
%
%
%
%\subsection{Page Breaks}
%\label{sec:ug_page_breaks}
%
% \DescribeMacro{\clearpage}
% \DescribeMacro{\cleardoublepage}
% \DescribeMacro{\clearspread}
% Standard \LaTeX\ has commands for immediate page break
% (e.g. \cs{clearpage}) and for switching to the next recto page,
% possibly ejecting the next verso page (\cs{cleardoublepage}).  The
% class provides another command \cs{clearspread}.  It  switches to
% the next \emph{verso} page, possibly ejecting the next recto page
% (and putting there floats intended for this page, if any).  
%
%
%\subsection{Tables}
%\label{sec:ug_tables}
%
% \DescribeEnv{tablepages}
% The tables at the end of a part should be typeset inside
% |tablepages| environment.  The environment switches to the one
% column setup, decreases the margins and changes the font to
% \cs{narrowfamily}.  
%
% To typeset numericall items one should use |d| column identifier
% with the format |d|\marg{a.b}, where $a$ is the number of decimal
% in the integer part of the number, and $b$ is the number of decimal
% digitst in the fractional part.  For example, a number $12.345$
% corresponds to |d{2.3}|.  The column headers are usually \emph{not}
% numerical, so one need to use \cmd{\multicolumn} entries to typeset
% them.  The class defines several such entries:
% \begin{description}
% \item[H] produces a centered entry.
% \item[P] produces an entry of a given length, for example,
% |P{1.5cm}|
%
% \item[C] produces an entry of the length corresponding to 
% the given number of numerical columns.  For example, |C{2}|
% corresponds to a header of two numerical columns.  Each column is
% assumed to be of the size enough to store $-99.999$.  
% \end{description}
% 
%
% \DescribeMacro{\hhline}
% For the rules that do not span the table width
% \cmd{\hhline}\marg{specificaiton} command from the \progname{hhline}
% package should be used.  The \marg{specification} argument of this
% command has many variants, but for our purposes we need only one
% variant: the command |-| produces a horizontal line spanning one
% column.  The color of this line is determined by the command
% \cmd{\arrayrulecolor}\marg{color}, issued in the last |>|\marg{argument}
% command before the |-| specification.  Therefore the command
% |>{\arrayrulecolor{@tableheadcolor}}-| produces a line of the color
% |@tableheadcolor|, which is seen as the absence of line.  The
% command |>{\arrayrulecolor{black}}---| produces a black line
% spanning three columns. Thus if we have a four-column table and want
% a rule spanning columns 2--3, the following command should be issued:
% \begin{verbatim}
%   \hhline{>{\arrayrulecolor{@tableheadcolor}}-% Column 1, no rule
%     >{\arrayrulecolor{black}}--%  Columns 2 and 3, black rule
%     >{\arrayrulecolor{@tableheadcolor}}-}% Column 4, no rule
% \end{verbatim}
% The usual |*| specification may be used for repeating patterns, for
% example, |*{5}{-}| is equivalent to |-----|.  
%
% The vertical bar \verb+|+ specification in the \cmd{\hhline}
% argument means an interruption of the line. The interruption is by
% defalut a black interval, to make it the same color as the header
% background, use \verb+>{\arrayrulecolor{@tableheadcolor}}|+. 
%
% The design of the tables in the current edition requires several
% important changes to the usual tables:
% \begin{enumerate}
% \item There should be no \cs{toprule} at the beginning of a table.
% \item The first row header of a table must be empty and white; this
%   is done by the command |\cellcolor{white}| in this cell.
% \item \cs{hhline} separating rows in the header must not go through
% this first white cell;  this is done by the |~| specificaton.
% \end{enumerate}
% 
%
%
%\subsection{Publication Descriptions}
%\label{sec:ug_publications}
%
% \DescribeMacro{\KeyResources}
% Publication descriptions normally are collected in a special section
% inside part introduction.  This section is introduced by the command
% \cs{KeyResources}.  There are two options that must be set by
% \cs{faoset} to use by this
% command:  |resourcesicon| and |resourcesname|.  The first is the
% filename of the icon used for section heading, the second is the
% name of the section, for example
% \begin{verbatim}
% \faoset{resourcesicon=icons/resources.png, 
%    resourcesname={Key Resources}}
% \end{verbatim}
% 
%
% \DescribeEnv{publication} FAO yearboook describes some FAO
% publications.  These publications should be put inside the
% environment |publication|.  The environment has one mandatory
% argument, which is the title of the publication, and one optional
% argument, which sets the file name of the publication cover. Note
% that the option argument, if present, must precede the mandatory
% one. If this
% argument is absent, no cover is included.
% \DescribeMacro{\pDescription} 
% \DescribeMacro{\pEdition} \DescribeMacro{\pCycle} 
% \DescribeMacro{pWeb}
% Inside the
% environment the macros \cmd{\pDescription}\marg{description},
% \cmd{\pEdition}\marg{year}\marg{edition}, \cmd{\pWeb}\marg{URL}
% and \cmd{\pCycle}\marg{date} are used to typeset the corresponding
% items related to the publication.  For example,
% \begin{verbatim}
% \begin{publication}[./Plots/StateOfFoodAndAgriculture.png]{The State
%     of Food and Agriculture}
%   \pDescription{The State of Food and Agriculture, FAO's major
%     annual flagship publication, aims at bringing to a wider
%     audience balanced science-based assessments of important issues
%     in the field of food and agriculture.  Each edition of the
%     report contains a comprehensive, yet easily accessible, overview
%     of a selected topic of major relevance for rural and
%     agricultural development and for global food security.  This is
%     supplemented by a synthetic overview of the current global
%     agricultural situation.}
%  \pEdition{2010}{Livestock in the balance}
%  \pEdition{2011}{Women in Agriculture Closing the gender gap for
%    development} 
%  \pCycle{May each year}
%  \pWeb{http://www.fao.org/docrep/013/i2050e/i2050e00.htm}
% \end{publication}
% \end{verbatim}
% Note that, as in the example, some fields may be repeated.  
%
% \DescribeMacro{publicationparskip}
% \DescribeMacro{publicationskip}
% Two spacing parameters can be used for typesetting of publications:
% |publicationskip| is the amount of additional space between the publications,
% while |publicationparskip| is the space between the paragraphs
% inside the publication environment.  The default values correspond
% to the command
% \begin{verbatim}
% \faoset{publicationskip=6pt plus 2pt minus 2pt,
%         publicationparskip=6pt plus 6pt minus 4pt}
% \end{verbatim}
% 
% 
%
%\subsection{Metadata}
%\label{sec:ug_metadata}
%
% \DescribeMacro{\metadatasection}
% The sources of the data are collected in special sections called
% ``Metadata section''.  Each section is introduced by the command
% \cs{metadatasection}\marg{title}, for example,
% \begin{verbatim}
% \metadatasection{Indicators}
% \end{verbatim}
% 
%
% \DescribeEnv{metadata}
% The sources themselves are collected in the
% |metadata| environments.  Each environment has one obligatory
% argument---the name of the source.  It may include the following commands:
% \begin{description}
% \item[\cmd{\key}\marg{key}]\DescribeMacro{\key} sets the 
%   corresponding key which is used for labeling the metadata
% \item[\cmd{\source}\marg{source}]\DescribeMacro{\source} sets the
% source of the data.
% \item[\cmd{\owner}\marg{owner}]\DescribeMacro{\owner} sets the owner
% of the data.
% \end{description}
% Note that there is no ``description'' command because any text which
% is not an argument of the commands above is considered to belong to
% the description of the data.
%
% Example of the usage of these commands:
% \begin{verbatim}
% \metadatasection{Indicators}
% \begin{metadata}{Agricultural population} 
%   \key{agripop}%
%    Agricultural population is defined as all persons depending for
%    their livelihood on agriculture, hunting, fishing and forestry.
%    It comprises all persons economically active in agriculture as
%    well as their non-working dependents. It is not necessary that
%    this referred population exclusively come from rural population.
%    \source{FILL ME}
%    \owner{FILL ME}
% \end{metadata}
% \end{verbatim}
%
% Each indicator is preceded by a square, normally grey-colored.  The
% command \cs{faoset} with the key |indicatorsquarecolor| can be used
% to set the color of the square, for example
% \begin{verbatim}
% \faoset{indicatorsquarecolore={black!10}}
% \end{verbatim}
% 
%
% \DescribeMacro{\refMetadata}
% The metadata is referenced by the command
% \cmd{\refMetdata}\marg{key}, for example
% \begin{verbatim}
% \refMetadata{agripop}
% \end{verbatim}
% This command will not be typeset, but makes creates a backreference
% to the corresponding chart from the indicator section.
%
%
% Note that the package automatically provides backreferencing: all
% charts, maps and tables where the medatada is referenced, are
% mentioned in the corresponding metadata section.
%
%
%\subsection{Further Reading}
%\label{sec:ug_further_reading}
% 
% \DescribeEnv{freading}
% The special environment |freading| is used for the ``further
% reading'' sections of the book.  It starts the text from the new
% page and changes some defaults.  
%
%
%\subsection{Subscripts in Text}
%\label{sec:ug_textsubscript}
%
% \DescribeMacro{\textsubscript}
% The standard \LaTeX{} defines \cmd{\textsuperscript}.  The class
% adds a similar \cmd{\textsubscript} command.
%
% 
%
%
%\StopEventually{%
% \clearpage
% \bibliography{faosyb}
% \bibliographystyle{unsrt}}
% \clearpage
%
%
%\section{Implementation}
%\label{sec:implementation}
%
% 
%\subsection{Options}
%\label{sec:options}
% 
% \begin{macro}{\faoyearbook@size@warning}
% The font-changing options are not used in our setup, so we just
% produce a warning:
%    \begin{macrocode}
\long\def\faoyearbook@size@warning#1{%
  \ClassWarning{faoyearbook}{Size-changing option #1 will not be
    honored}}%
\DeclareOption{8pt}{\faoyearbook@size@warning{\CurrentOption}}%
\DeclareOption{9pt}{\faoyearbook@size@warning{\CurrentOption}}%
\DeclareOption{10pt}{\faoyearbook@size@warning{\CurrentOption}}%
\DeclareOption{11pt}{\faoyearbook@size@warning{\CurrentOption}}%
\DeclareOption{12pt}{\faoyearbook@size@warning{\CurrentOption}}%      
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\ifprint}
%   We have a flag shich shows whether we are in Web or print mode
%    \begin{macrocode}
\newif\ifprint
\printfalse
\DeclareOption{web}{\printfalse
  \PassOptionsToPackage{paper=a4paper}{geometry}}
\DeclareOption{print}{\printtrue
  \PassOptionsToPackage{papersize={230mm,317mm},
    layouthoffset=1cm,layoutvoffset=1cm}{geometry}}
%    \end{macrocode}   
% \end{macro}
%
% \begin{macro}{\ifDraft}
%   If we are in `Draft' or `draft mode', we print a word `draft'
%   across the page:
%    \begin{macrocode}
\newif\ifDraft
\Draftfalse
\DeclareOption{Draft}{\Drafttrue}
\DeclareOption{draft}{\Drafttrue}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\if@issuumode}
%   Whether we need issuu-style links
%    \begin{macrocode}
\newif\if@issuumode
\@issuumodefalse
\DeclareOption{issuu}{\@issuumodetrue}
%    \end{macrocode}
%   
% \end{macro}
%
% All other options are just sent to the main class:
%    \begin{macrocode}
\DeclareOption*{\PassOptionsToClass{\CurrentOption}{report}}
\ProcessOptions\relax
%    \end{macrocode}
% 
%\subsection{Loading Class and Packages}
%\label{sec:loading}
%
% We start with the base class and some packages
%    \begin{macrocode}
\LoadClass[10pt,twoside,twocolumn]{report}
\RequirePackage{graphicx,xkeyval}
\RequirePackage[table,cmyk]{xcolor}
\RequirePackage{tikz,dcolumn}
\RequirePackage{geometry}
\usetikzlibrary{calc}
\RequirePackage{fancyhdr}
\RequirePackage{lscape,longtable,siunitx,booktabs}
\RequirePackage{multicol,atbegshi,picture,hhline,afterpage}
\RequirePackage[T1]{fontenc}
\RequirePackage[utf8x]{inputenc}
\RequirePackage{pdfpages}
\RequirePackage[authoryear]{natbib}
\RequirePackage[breaklinks]{hyperref}
\RequirePackage{bookmark}
\RequirePackage{adjmulticol,lettrine}
\if@issuumode
\RequirePackage{issuulinks}
\fi
%    \end{macrocode}
%
% Options for the hyperef package are set as follows:
%    \begin{macrocode}
\hypersetup{breaklinks,colorlinks=false,pdfborder=0 0 0,    
  pdfauthor={FAO},
  pdfsubject={Statistical Yearbook of the Food And Agricultural Organization for the United Nations},
  pdftitle={Statistical Yearbook of the Food And Agricultural Organization for the United Nations},
  pdfkeywords={FAO, Food Security, Undernourishment, Sustainable agriculture},
  pdfpagelayout=TwoColumnLeft,
  pdfnewwindow=true
}
%    \end{macrocode}
%
%\subsection{Color}
%\label{sec:colors}
%
% We need to tell the printer that we are using CMYK color model.  The
% following is taken from the |pdfx| package (the package itself is
% not too easy to make work).
%    \begin{macrocode}
\def\@pctchar{\expandafter\@gobble\string\%}
\def\@bchar{\expandafter\@gobble\string\\}
\immediate\pdfobj stream attr{/N 4}  file{FOGRA39L.icc}
\edef\OBJ@CVR{\the\pdflastobj}
\pdfcatalog{/OutputIntents [ <<
  /Type/OutputIntent
  /S/GTS_PDFX
  /OutputCondition (FOGRA39)
  /OutputConditionIdentifier (FOGRA39 \@bchar(ISO Coated v2
   300\@pctchar\space \@bchar(ECI\@bchar)\@bchar))
  /DestOutputProfile \OBJ@CVR\space 0 R
  /RegistryName(http://www.color.org)
 >> ]}
%    \end{macrocode}
%
% \begin{macro}{\LettrineFontHook}
% \changes{v1.3}{2013/12/16}{Redefined}
%   We want the drop caps to have |@bgcolor|
%    \begin{macrocode}
\renewcommand\LettrineFontHook{\color{@bgcolor}}
%    \end{macrocode}
%   
% \end{macro}
% \begin{macro}{\DefaultFindent}
%   The distance between the dropped capital and the text
%    \begin{macrocode}
\setlength\DefaultFindent{2pt}
%    \end{macrocode}
%   
% \end{macro}
%
%\subsection{Key-Value Interface}
% \label{sec:keyval}
%
% \begin{macro}{\faoset}
%   We define the family |fao| for our keys:
%    \begin{macrocode}
\def\faoset#1{\setkeys{fao}{#1}}
%    \end{macrocode}
%   
% \end{macro}
%
% One of the important keys is |year|
%    \begin{macrocode}
\define@key{fao}{year}{\gdef\fao@year{#1}}
\faoset{year=20XX}
%    \end{macrocode}
%
%  
%
%\subsection{Fonts}
%\label{sec:fonts}
%
% We use arev for mathematics:
%    \begin{macrocode}
\RequirePackage{arevmath}
%    \end{macrocode}
%
% For body text we use PT~Sans:
%    \begin{macrocode}
\def\PTSans@scale{0.95}
\def\PTSansNarrow@scale{0.95}
\def\PTSansCaption@scale{0.95}
\renewcommand{\sfdefault}{PTSans-TLF}
\renewcommand{\familydefault}{\sfdefault}
\renewcommand{\bfdefault}{b}
%    \end{macrocode}
%
% \begin{macro}{\narrowfamily}
%   We declare a new family, \cs{narrowfamily}:
%    \begin{macrocode}
\DeclareRobustCommand\narrowfamily{\fontfamily{PTSansNarrow-TLF}\selectfont}
%    \end{macrocode}
% \end{macro}
% \begin{macro}{\textnarrow}
%   And the matching \cs{textnarrow} command:
%    \begin{macrocode}
\DeclareTextFontCommand{\textnarrow}{\narrowfamily}
%    \end{macrocode}   
% \end{macro}
%
%
% \begin{macro}{\captionfamily}
%   Same with  \cs{captionfamily}:
%    \begin{macrocode}
\DeclareRobustCommand\captionfamily{\fontfamily{PTSansCaption-TLF}\selectfont}
%    \end{macrocode}
% \end{macro}
% \begin{macro}{\textcaption}
%   And the matching \cs{textcaption} command:
%    \begin{macrocode}
\DeclareTextFontCommand{\textcaption}{\captionfamily}
%    \end{macrocode}   
% \end{macro}
%
%
% \begin{macro}{\normalsize}
%   The basic size is 9.6pt:
%    \begin{macrocode}
\renewcommand\normalsize{%
   \@setfontsize\normalsize{9.6pt}{\@xiipt}%
   \abovedisplayskip 10\p@ \@plus2\p@ \@minus5\p@
   \abovedisplayshortskip \z@ \@plus3\p@
   \belowdisplayshortskip 6\p@ \@plus3\p@ \@minus3\p@
   \belowdisplayskip \abovedisplayskip
   \let\@listi\@listI}
\normalsize
%    \end{macrocode}   
% \end{macro}
%
%
% \begin{macro}{\small}
% This is the small size:
%    \begin{macrocode}
\renewcommand\small{%
   \@setfontsize\small\@ixpt{10}%
   \abovedisplayskip 8.5\p@ \@plus3\p@ \@minus4\p@
   \abovedisplayshortskip \z@ \@plus2\p@
   \belowdisplayshortskip 4\p@ \@plus2\p@ \@minus2\p@
   \def\@listi{\leftmargin\leftmargini
               \topsep 4\p@ \@plus2\p@ \@minus2\p@
               \parsep 2\p@ \@plus\p@ \@minus\p@
               \itemsep \parsep}%
   \belowdisplayskip \abovedisplayskip}
%    \end{macrocode}
% \end{macro}
%
%
% We use |rm| style of URL:
%    \begin{macrocode}
\urlstyle{sf}
%    \end{macrocode}
% 
%\subsection{Margins and Paragraphing}
%\label{sec:pars}
%
% \changes{v1.4}{2013/12/17}{Changed dimensions}
% \begin{macro}{\parindent}
% \begin{macro}{\parskip}
%   We use not indented paragraphs with paragraph borders given by
%   skips
%    \begin{macrocode}
\setlength\parindent\z@
\setlength\parskip{6\p@ plus 6\p@ minus 4\p@}
%    \end{macrocode}
%   
% \end{macro}
% \end{macro}
%
% \changes{v1.6}{2013/12/19}{Added 3mm to the bottom margin}
%
%  We use a4paper.  
%    \begin{macrocode}
\geometry{layout=a4paper,
    left=5cm,right=3.5cm,bottom=2.3cm,top=76mm,
    footskip=8mm, head=30mm, headsep=3mm,
    columnsep=6mm, twoside}%
\savegeometry{frontmatter}
\geometry{layout=a4paper,
  left=2cm,right=2cm,bottom=2.3cm,top=2.3cm,
  footskip=8mm, head=30mm, headsep=3mm,
  columnsep=6mm, twoside}%
\savegeometry{standard}
%    \end{macrocode}
%
%
%\subsection{Cropmarks}
%\label{sec:cropmarks}
%
% There are several packages that provide crop marks.  Unfortunately
% they do not work for us because they put crop marks at the
% background.  Since we have colored pages, we want crop marks to be
% on the foreground.
%
% In this section we re-implement cropmarks of the \progname{geometry}
% package, putting the marks on the foreground.
%
% We postpone the code to the beginning of the document to get the
% proper value of the switch
%    \begin{macrocode}
\AtBeginDocument{\ifprint
  \AtBeginShipout{%
    \AtBeginShipoutUpperLeftForeground{%
      \color{black}%
      \@tempdima=\Gm@layouthoffset
     \@tempdimb=\Gm@layoutvoffset
      \put(\@tempdima,-\@tempdimb+6\p@){\line(0,1){50}}%
      \put(\@tempdima-6\p@,-\@tempdimb){\line(-1,0){50}}%
      \advance\@tempdima by \Gm@layoutwidth
      \put(\@tempdima,-\@tempdimb+6\p@){\line(0,1){50}}%
      \put(\@tempdima+6\p@,-\@tempdimb){\line(1,0){50}}%
      \advance\@tempdimb by \Gm@layoutheight
      \put(\@tempdima,-\@tempdimb-6\p@){\line(0,-1){50}}%
      \put(\@tempdima+6\p@,-\@tempdimb){\line(1,0){50}}%
      \advance\@tempdima by -\Gm@layoutwidth
      \put(\@tempdima-6\p@,-\@tempdimb){\line(-1,0){50}}%
      \put(\@tempdima,-\@tempdimb-6\p@){\line(0,-1){50}}%
    }}\fi}
%    \end{macrocode}
% 
% In draft mode we put the word `DRAFT' across the page:
%    \begin{macrocode}
\AtBeginDocument{\ifDraft
  \AtBeginShipout{%
    \AtBeginShipoutUpperLeft{%
      \color{black!25}%
      \@tempdima=\Gm@layouthoffset
      \@tempdimb=\Gm@layoutvoffset
      \advance\@tempdima by 0.2\Gm@layoutwidth
      \advance\@tempdimb by 0.7\Gm@layoutheight
      \put(\@tempdima,-\@tempdimb){%
        \rotatebox{45}{%
          \fontsize{6cm}{6cm}\selectfont 
          DRAFT}}}}\fi}
%    \end{macrocode}
% 
% 
%
%\subsection{Setting Colors and Icons}
%\label{sec:setting_colors_icons}
%
% \begin{macro}{\fao@color@string}
%   This is the command that remembers the present color for TOC
%    \begin{macrocode}
\def\fao@color@string{0,0,0}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{@bgcolor@next}
%   We store the next background color in |@bgcolor@next|.
%  We store the next heading background in |@tableheadcolor@next|.
% \begin{macro}{\setbgcolor}
%   The command |\setbgcolor| selects the next background color:
%    \begin{macrocode}
\def\setbgcolor#1{\colorlet{@bgcolor@next}[cmyk]{#1}%
  \@for\curr@ext:=\@toc@ext@list\do{%
    \addtocontents{\curr@ext}{\string\colorlet{@bgcolor}[cmyk]{#1}}}%
  \addtocontents{toc}{\string\colorlet{@bgcolor}[cmyk]{#1}}%
  \gdef\fao@color@string{#1}}
\colorlet{@bgcolor@next}[cmyk]{white}
%    \end{macrocode}
% \end{macro}   
% \end{macro}
%
%  The key-value interface for the same command:
%    \begin{macrocode}
\define@key{fao}{bgcolor}{\setbgcolor{#1}}
%    \end{macrocode}
%  
% And for separate setting of |@tableheadcolor|
%    \begin{macrocode}
\define@key{fao}{tableheadcolor}{\colorlet{@tableheadcolor}[cmyk]{#1}}
%    \end{macrocode}
%
% \begin{macro}{@bgcolor}
% The current color is in the macro |@bgcolor|.
% \begin{macro}{@tableheadcolor}
% \begin{macro}{\selectcolor}
%   This command makes the actual color change:
%    \begin{macrocode}
\def\selectcolor{\colorlet{@bgcolor}{@bgcolor@next}%
  \colorlet{@tableheadcolor}{@bgcolor}}
\selectcolor
%    \end{macrocode}
%   
% \end{macro}
% \end{macro}
% \end{macro}
% 
% \begin{macro}{@tablebg}
%   The color for table pages
%    \begin{macrocode}
\define@key{fao}{tablebg}{\colorlet{@tablebg}[cmyk]{#1}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\seticon}
%   Setting the next icon for the part
%    \begin{macrocode}
\def\seticon#1{\gdef\next@icon{#1}}
\define@key{fao}{icon}{\seticon{#1}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\selecticon}
% \begin{macro}{\currenticon}
%   The actual icon change
%    \begin{macrocode}
\def\selecticon{\gdef\currenticon{\next@icon}}
\def\next@icon{}
%    \end{macrocode}
%   
% \end{macro}
% \end{macro}
%
%
% \begin{macro}{\newicon}
% \changes{v0.2}{2013/12/10}{Added macro}
%   Define an icon |#2| for the part |#1|
%    \begin{macrocode}
\def\newicon#1#2{\expandafter\gdef\csname @icon@#1\endcsname{#2}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\colored@icon}
% \changes{v1.0}{2012/12/13}{Added macro}
%   The icon for us is just a mask.  This will create a colored icon
%   using background |@bgcolor|
%    \begin{macrocode}
\newcommand\colored@icon[2][]{\bgroup\fboxsep=-1pt%
  \fcolorbox{white}{@bgcolor}{\includegraphics[#1]{#2}}\egroup}
%    \end{macrocode}
%   
% \end{macro}
% \begin{macro}{\colored@icon@fg}
% \changes{v1.0}{2012/12/13}{Added macro}
% \changes{v1.1}{2012/12/13}{Added argument}
%   The icon for us is just a mask.  This will create a colored icon
%   using background |@bgcolor!#3|
%    \begin{macrocode}
\newcommand\colored@icon@fg[3][]{\bgroup\fboxsep=-1\p@%
  \fcolorbox{white}{@bgcolor!#3}{\includegraphics[#1]{#2}}\egroup}
%    \end{macrocode}
%   
% \end{macro}
%
%\subsection{Page Styles}
%\label{sec:pagestyles}
%
% \begin{macro}{\evenfootmark}
% \changes{v1.3}{2013/12/14}{Introduced macro}
%   The mark on even pages
%    \begin{macrocode}
\def\evenfootmark#1{\gdef\@evenfootmark{#1}}
\evenfootmark{\textbf{FAO} Statistical Yearbook \textbf{\fao@year}}
%    \end{macrocode}
%   
% \end{macro}
% \begin{macro}{\oddfootmark}
% \changes{v1.3}{2013/12/14}{Introduced macro}
%   The mark on odd pages
%    \begin{macrocode}
\def\oddfootmark#1{\gdef\@oddfootmark{#1}}
\oddfootmark{\rightmark}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{frontmatterpagestyle}
% \changes{v1.4}{2013/12/17}{Introduced macro}
% \changes{v1.7}{2014/04/07}{Moved folios}
%   This is our  page style for front matter
%    \begin{macrocode}
\fancypagestyle{frontmatterpagestyle}{%
  \fancyhf{}%
  \fancyhfoffset[LR]{2cm}%
  \renewcommand\headrulewidth{\z@}%
  \fancyfoot[RO,LE]{%
    \bgroup 
    \setlength\fboxsep{10\p@}%
    \raisebox{\dimexpr(-\height-.5cm)}{\fcolorbox{white}{white}{\thepage}}%
  \egroup}%
}
%   
% \end{macro}
% \begin{macro}{spartpagestyle}
% \changes{v1.4}{2013/12/17}{Introduced macro}
%   This is our  page style for front matter
%    \begin{macrocode}
\fancypagestyle{spartpagestyle}{%
  \fancyhf{}%
  \fancyhfoffset[LR]{3cm}%
  \renewcommand\headrulewidth{\z@}%
  \fancyfoot[RO,LE]{%
    \bgroup 
    \setlength\fboxsep{10\p@}%
    \raisebox{-\height}{\fcolorbox{white}{white}{\thepage}}%
  \egroup}%
}
%   
% \end{macro}
%
% \begin{macro}{\@foliobox}
% \changes{v1.6}{2013/12/19}{Introduced macro}
%   This is the macro that typesets the page number in a colorbox of
%   the required size
%    \begin{macrocode}
\def\@foliobox{\bgroup\normalsize\normalfont\fboxsep=5mm\relax
  \fcolorbox{@bgcolor}{@bgcolor}{\parbox{4mm}{\centering
      \color{white}\thepage\strut}}\egroup}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{standardpagestyle}
% \changes{v1.3}{2013/12/14}{Changed position of footers}
% \changes{v1.4}{2013/12/17}{Increased sizes}
% \changes{v1.5}{2013/12/18}{Changed bottom margins}
% \changes{v1.6}{2013/12/19}{Used foliobox}
%   This is our main page style
%    \begin{macrocode}
\fancypagestyle{standardpagestyle}{%
  \fancyhf{}%
  \fancyhfoffset[LR]{2.12cm}%
  \renewcommand\headrulewidth{\z@}%
  \fancyhead[LE]{\hspace*{25\p@}\color{@bgcolor}\captionfamily
    \Huge\strut\ifnum\thepart>0\relax
    \thepart\fi\normalsize\dotfill}%
  \fancyhead[LO]{\hspace*{25\p@}\color{@bgcolor}\normalsize\dotfill
    \captionfamily\Huge\strut
    \leftmark\expandafter\ifx\csname @icon@\thepart\endcsname\relax\else\space
      \raisebox{-0.25\totalheight}{%
        \colored@icon[width=1.2cm]{\csname
          @icon@\thepart\endcsname}}\fi
      \hspace*{25\p@}}%
  \fancyfoot[LE]{%
    \bgroup
    \setlength\fboxsep{11\p@}%
    \color{@bgcolor}%
    \raisebox{-\height}{\@foliobox}%
    \normalsize\dotfill
    \raisebox{-\height}{\@evenfootmark\hspace*{25\p@}}%
  \egroup}%
  \fancyfoot[LO]{%
    \bgroup
    \setlength\fboxsep{11\p@}%
    \color{@bgcolor}%
    \raisebox{-\height}{\hspace*{25\p@}\@oddfootmark}%
    \normalsize\dotfill
    \raisebox{-\height}{\@foliobox}%
  \egroup}%
}
\pagestyle{standardpagestyle}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\@partpagerpicture}
% \changes{v1.3}{2013/12/14}{Rewrote using tikz}
%   A picture in the part page.  \cs{@part} defines it to the
%   combination of the current icons
%    \begin{macrocode}
\def\@partpagepicture{}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{partpagestyle}
% \changes{v1.3}{2013/12/14}{Changed position of footers}
% \changes{v1.3}{2013/12/14}{Rewrote using tikz}
% \changes{v1.4}{2013/12/17}{Changed dimensions}
% \changes{v1.6}{2013/12/19}{Used foliobox}
%   The page style for the parts introduction
%    \begin{macrocode}
\fancypagestyle{partpagestyle}{%
  \fancyhf{}%
  \fancyhead[L]{%
    \begin{picture}(0,0)
      \@partpagepicture
      \put(-7,63){%
        \raisebox{-\height}{\begin{tikzpicture}
          \fill[color=@bgcolor,opacity=.1] 
          (0,0) rectangle ($(\textwidth,\textheight)+(5cm,5cm)$);
        \end{tikzpicture}}}
    \end{picture}}
  \fancyhfoffset[LR]{2.22cm}%
  \renewcommand\headrulewidth{\z@}%
  \fancyfoot[LE]{%
    \bgroup
    \setlength\fboxsep{10\p@}%
    \color{@bgcolor}%
    \raisebox{-\height}{\@foliobox}%
    \normalsize\dotfill
    \raisebox{-\height}{\@evenfootmark\hspace{20\p@}}%
  \egroup}%
  \fancyfoot[LO]{%
    \bgroup
    \setlength\fboxsep{10\p@}%
    \color{@bgcolor}%
    \raisebox{-\height}{\hspace*{25\p@}\@oddfootmark}%
    \normalsize\dotfill
    \raisebox{-\height}{\@foliobox}%
  \egroup}%
}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\fao@partblobtop}
% \begin{macro}{\fao@partblobbottom}
%   Some pages have ``part blobs'': colored blobs on the specific
%   positions of the page.  These macros set the top and the bottom of
%   the blob corresponding to the part set in the second parameter:
%    \begin{macrocode}
\def\fao@partblobtop#1#2{\expandafter\gdef\csname fao@blobstart#1\endcsname{#2}}
\def\fao@partblobbottom#1#2{\expandafter\gdef\csname fao@blobend#1\endcsname{#2}}
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
%
%\subsection{Nonfloats}
%\label{sec:floats}
%
% In Faoyearbook we used float package.  Since we changed too much in
% the internals, here we just rewrite the code from scratch.
%
% \begin{macro}{\@toc@ext@list}
% \changes{v0.3}{2013/12}{11}{Added macro}
%   Comma-separated list of extensions for toc-like files:
%    \begin{macrocode}
\gdef\@toc@ext@list{toc}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@vert@sep}
%   Vertical separation between the floats
%    \begin{macrocode}
\newlength\nf@vert@sep
\setlength\nf@vert@sep{10mm}
%    \end{macrocode}
% \end{macro}
%   
% \begin{macro}{\nf@width}
%   The width of the nonfloat
%    \begin{macrocode}
\newlength\nf@width
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@height}
%   The height of the nonfloat
%    \begin{macrocode}
\newlength\nf@height
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@captionheight}
% \changes{v1.4}{2013/12/17}{Changed size}
%   The height reserved for the caption
%    \begin{macrocode}
\newlength\nf@captionheight
\setlength\nf@captionheight{11mm}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@sourceheight}
% \changes{v1.4}{2013/12/17}{Changed}
%   The height reserved for the source lines
%    \begin{macrocode}
\newlength\nf@sourceheight
\setlength\nf@sourceheight{2\baselineskip}
%    \end{macrocode}
%   
% \end{macro}
%
%
% \begin{macro}{\nf@margin}
%   Margin for floats
%    \begin{macrocode}
\newlength\nf@margin
\setlength\nf@margin{12\p@}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@trianglebase}
%   The design requres a triangle under the caption.  Here it is
%    \begin{macrocode}
\newlength\nf@trianglebase
\setlength\nf@trianglebase{12\p@}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\chartwidth}
%   The resulting width of a chart
%    \begin{macrocode}
\newlength\chartwidth
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\chartheight}
%   The resulting width of a chart
%    \begin{macrocode}
\newlength\chartheight
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@topskip}
%   Top separation for a nonfloat
\newskip\nf@topskip
% \end{macro}
%
% \begin{macro}{\nf@bottomskip}
%   Bottom separation for a nonfloat
\newskip\nf@bottomskip
% \end{macro}
%
%
%
% \begin{macro}{\nonfloat@type}
%   The counter to keep the next type to assign
%    \begin{macrocode}
\newcount\nonfloat@type
\nonfloat@type=4\relax
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@contentsbox}
%   The box to keep the contents of the float
%    \begin{macrocode}
\newbox\nf@contentsbox
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@mainbox}
%   The box for the float
%    \begin{macrocode}
\newbox\nf@mainbox
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\newnon@float}
% \changes{v0.3}{2013/12/11}{Added writing extensions to the list of
% extensions} 
%   The macro \cs{newnon@float} has the following arguments:  TYPE,
%   EXT, NAME for example
% \begin{verbatim}
% \newnon@float{map}{lom}{Map}
% \end{verbatim}
%   It defines a nonfloat with these parameters.
%    \begin{macrocode}
\def\newnon@float#1#2#3{%
%    \end{macrocode}
%   First, we need to define |\ftype@TYPE|: the type of the float.
%   Note that tables are taken, so we need to make a special care of
%   nonfloats that correspond to floats.
%    \begin{macrocode}
  \expandafter\ifx\csname ftype@#1\endcsname\relax
    \expandafter\edef\csname ftype@#1\endcsname{\the\nonfloat@type}%
    \multiply\nonfloat@type by 2\relax
  \fi
%    \end{macrocode}
% Now we define the extension for the floats
%    \begin{macrocode}
  \expandafter\def\csname ext@#1\endcsname{#2}%
  \xdef\@toc@ext@list{\@toc@ext@list,#2}%
%    \end{macrocode}
% The macro \cs{fnum@TYPE} formats the line like ``Figure 1''.  We
% need to check whether the counter is defined
%    \begin{macrocode}
  \expandafter\ifx\csname the#1\endcsname\relax  
  \newcounter{#1}\fi
  \expandafter\def\csname fnum@#1\endcsname{#3~\csname
    the#1\endcsname}%
%    \end{macrocode}
% Now we want to define the environment TYPE.  Since it might be
% already defined, we first delete this definition, otherwise
% \cs{newenvironment} might throw an error
%    \begin{macrocode}
  \expandafter\let\csname #1\endcsname\relax
  \expandafter\let\csname end#1\endcsname\relax
%    \end{macrocode}
%  And the actual definition
%    \begin{macrocode}
  \newenvironment{#1}{\non@float{#1}}{\endnon@float}}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@getfirstletter}
%   An aux macro to get a first letter of a word.  Used in constructs
% \begin{verbatim}
% \edef\U{\@getfirstletter{AAAAA\@endword}}}
% \end{verbatim}
%   
%    \begin{macrocode}
\def\@getfirstletter#1{\@@getfirstletter#1}
\def\@@getfirstletter#1{#1\@gobbleword}
\def\@gobbleword#1\@endword{}
%    \end{macrocode}
%   
% \end{macro}
%
%
% \begin{macro}{\non@float}
%   Now we are ready to define the \cs{non@float} macro.  It has three
%   parameters:  TYPE, SIZE and PLACEMENT. \cs{nf@source} is the
%   source of the float.
%    \begin{macrocode}
\def\non@float#1#2#3{
  \def\@captype{#1}%
  \def\nf@size{#2}%
  \def\nf@placement{#3}%
%    \end{macrocode}
% The macro |\nf@vert@pos| is either |u| or |l|
%    \begin{macrocode}
  \lowercase{\xdef\nf@vert@pos{\@getfirstletter#3\@endword}}
  \global\let\nf@source\@empty
%    \end{macrocode}
%
% Define the source command inside float
%    \begin{macrocode}
  \def\source##1{\gdef\nf@source{##1}}
%    \end{macrocode}
% 
%
% Define the caption producing command:
%    \begin{macrocode}
\long\def\@makecaption##1##2{\long\gdef\nf@caption{%
    {\bfseries\large\color{white}
      \MakeUppercase{##1}: ##2}}}%
\gdef\nf@caption{}%
%    \end{macrocode}
% 
%
% We calculate the size of the float and skips
%    \begin{macrocode}
  \nf@width=\columnwidth  
  \nf@height=\dimexpr(\textheight/2-\nf@vert@sep)%
  \if\nf@vert@pos u\relax
    \nf@topskip=\z@
    \nf@bottomskip=\nf@vert@sep
  \else
    \nf@topskip=\nf@vert@sep%
    \nf@bottomskip=\z@
  \fi
  \def\tempW{W}%
  \def\tempT{T}%
  \def\tempB{B}%
  \ifx\nf@size\tempW
    \nf@width=\textwidth
  \fi
  \ifx\nf@size\tempT
    \nf@height=\textheight
    \nf@topskip=\z@
    \nf@bottomskip=\z@
  \fi
  \ifx\nf@size\tempB
    \nf@width=\textwidth
    \nf@height=\textheight
    \nf@topskip=\z@
    \nf@bottomskip=\z@
  \fi
  \chartheight=
    \dimexpr(\nf@height-\nf@captionheight-\nf@sourceheight
    -2\nf@margin-\nf@trianglebase)%
  \ifx\nf@size\tempB
    \advance\chartheight by -2\baselineskip
  \fi
  \ifx\nf@size\tempT
    \advance\chartheight by -2\baselineskip
  \fi
  \chartwidth=\dimexpr(\nf@width-2\nf@margin-0.5\nf@trianglebase)%
  \nf@height=\dimexpr(\nf@height+\nf@topskip+\nf@bottomskip)%
%    \end{macrocode}
%
%  Now we construct the main box.
%    \begin{macrocode}
  \global\setbox\nf@contentsbox
    \color@vbox
     \normalcolor
     \vbox to \chartheight
     \bgroup
     \hsize\chartwidth
     \@parboxrestore
     \@floatboxreset
}
%    \end{macrocode}
%  
% 
% \end{macro}
%
% \begin{macro}{\endnon@float}
% \changes{v1.0}{2013/12/13}{Source in normal color}
%   The actual typesetting
%    \begin{macrocode}
\def\endnon@float{\@endfloatbox\par
  \hsize=\nf@width
  \setbox\nf@mainbox=\vbox to \nf@height\bgroup
    \hsize=\chartwidth
    \vskip\nf@topskip
    \noindent
    \begin{picture}(0,0)%
      \put(0,0){\color{@bgcolor}%
        \begin{tikzpicture}[baseline=(current bounding box.north)]
          \fill (0,0) -- (\nf@trianglebase,0) -- 
          (0.5\nf@trianglebase,-\nf@trianglebase) -- cycle;
        \end{tikzpicture}}
    \end{picture}%
    \def\@tempa{chart}%
    \ifx\@tempa\@captype 
    \begin{picture}(0,0)%
      \put(0,0){\color{@bgcolor}%
        \begin{tikzpicture}[baseline=(current bounding box.north)]
          \draw(0,0) -- (\nf@width,0);
          \draw (0.5\nf@trianglebase,-2\nf@trianglebase) -- 
          (0.5\nf@trianglebase,-\chartheight-2\nf@trianglebase
          -\nf@margin) -- 
          (\nf@width-\pgflinewidth, -\chartheight-2\nf@trianglebase
          -\nf@margin) -- (\nf@width-\pgflinewidth, 0);
        \end{tikzpicture}}
    \end{picture}%
    \fi
    {\color{@bgcolor}\color@block{\nf@width}{\nf@captionheight}{.1\p@}}%
    \hskip\dimexpr(\nf@margin+0.5\nf@trianglebase)%
    \vbox to \nf@captionheight\bgroup    
    \nf@caption\vfill\normalcolor
    \egroup\par\nointerlineskip\vskip\nf@trianglebase
    \vskip\nf@margin
    \noindent\hskip\dimexpr(\nf@margin+0.5\nf@trianglebase)%
    \box\nf@contentsbox\par\nointerlineskip
    \vskip\nf@margin
    \hskip\dimexpr(\nf@margin+0.5\nf@trianglebase)%
    \vbox to \nf@sourceheight\bgroup
    \leftskip-\nf@margin\parskip\z@\parindent\z@
    \ifx\nf@source\@empty\else
    \vskip0.5\baselineskip
    \color{@bgcolor}%
      \rule{.2em}{.2em}~\rule{.2em}{.2em}~%
      \rule{.2em}{.2em}~\rule{.2em}{.2em}~%
      \rule{.2em}{.2em}~\rule{.2em}{.2em}~%
      \rule{.2em}{.2em}\par\normalcolor
    Source: \nf@source\par\vfill\fi\egroup
    \vfill\egroup
    \edef\nf@currbox{\expandafter\csname nfbox@\nf@size 
      @\nf@placement\endcsname}%
    \global\setbox\nf@currbox=
    \vbox{\box\nf@currbox\nointerlineskip\penalty0\box\nf@mainbox}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\map}
%   A standard nonfloat:
%    \begin{macrocode}
\newnon@float{map}{lom}{Map}
%    \end{macrocode}
% \end{macro}
% 
%
% \begin{macro}{\listofmapsname}
%   \changes{v0.3}{2013/12/11}{Added macro}
% The name for the list of maps
%    \begin{macrocode}
\def\listofmapsname{List of Maps}
%    \end{macrocode}
% \end{macro}
% 
% \begin{macro}{\table}
%   Another one
%    \begin{macrocode}
\newnon@float{table}{lot}{Table}
%    \end{macrocode}
%   
% \end{macro}
% \begin{macro}{\chart}
%   And another one
%    \begin{macrocode}
\newnon@float{chart}{loc}{Chart}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\listofchartsname}
%   \changes{v0.3}{2013/12/11}{Added macro}
% The name for the list of charts
%    \begin{macrocode}
\def\listofchartsname{List of charts}
%    \end{macrocode}
% \end{macro}
%
%\subsection{Output Routine}
%\label{sec:output_routine}
%
% This is hairy because output routines are hairy\dots
%
% We need several insert boxes.  Naming convention: the letter for the
% box size and two letter code for the location.  We use \cs{newbox}
% instead of \cs{newinsert} since we do not use associated \cs{count},
% \cs{dimen} and \cs{skip} registers.
%    \begin{macrocode}
\newbox\nfbox@S@ul
\newbox\nfbox@S@ur
\newbox\nfbox@S@ll
\newbox\nfbox@S@lr
\newbox\nfbox@S@UL
\newbox\nfbox@S@UR
\newbox\nfbox@S@LL
\newbox\nfbox@S@LR
\newbox\nfbox@T@ul
\newbox\nfbox@T@ur
\newbox\nfbox@T@UL
\newbox\nfbox@T@UR
\newbox\nfbox@W@ul
\newbox\nfbox@W@ll
\newbox\nfbox@W@UL
\newbox\nfbox@W@LL
\newbox\nfbox@B@ul
\newbox\nfbox@B@UL
%    \end{macrocode}
% 
% \begin{macro}{\@tempboxb}
%   Standard \LaTeX\ has \cs{@tempboxa}.  We need more\dots
%    \begin{macrocode}
\ifx\@tempboxb\@undefined
  \newbox\@tempboxb
\fi
%    \end{macrocode}
%   
% \end{macro}
%
%
% \begin{macro}{\standard@output}
%   The standard \LaTeX\ output routine is saved as
%   \cs{standard@output}.  We use it for one column pages---maybe one
%   even wants a standard float here?
%    \begin{macrocode}
\edef\standard@output{\the\output}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\output}
%   Right now we use standard output on one column pages and the new
%   one with two columns
%    \begin{macrocode}
\output{\if@twocolumn\the\nf@output\else\standard@output\fi}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@output}
%   Here we define our own output routine.
%    \begin{macrocode}
\newtoks\nf@output
\nf@output {%
%    \end{macrocode}
%
% We define the current boxes 
% \cs{curr@nfbox...}.  Also, |uc| or |lc| mean Upper or Lower Current column
%    \begin{macrocode}
  \ifodd\c@page
    \global\let\curr@nfbox@S@ul\nfbox@S@UL
    \global\let\curr@nfbox@S@ur\nfbox@S@UR
    \global\let\curr@nfbox@S@ll\nfbox@S@LL
    \global\let\curr@nfbox@S@lr\nfbox@S@LR
    \global\let\curr@nfbox@T@ul\nfbox@T@UL
    \global\let\curr@nfbox@T@ur\nfbox@T@UR
    \global\let\curr@nfbox@W@ul\nfbox@W@UL
    \global\let\curr@nfbox@W@ll\nfbox@W@LL
    \global\let\curr@nfbox@B@ul\nfbox@B@UL
  \else
    \global\let\curr@nfbox@S@ul\nfbox@S@ul
    \global\let\curr@nfbox@S@ur\nfbox@S@ur
    \global\let\curr@nfbox@S@ll\nfbox@S@ll
    \global\let\curr@nfbox@S@lr\nfbox@S@lr
    \global\let\curr@nfbox@T@ul\nfbox@T@ul
    \global\let\curr@nfbox@T@ur\nfbox@T@ur
    \global\let\curr@nfbox@W@ul\nfbox@W@ul
    \global\let\curr@nfbox@W@ll\nfbox@W@ll
    \global\let\curr@nfbox@B@ul\nfbox@B@ul
  \fi
  \if@firstcolumn
    \global\let\curr@nfbox@S@uc\curr@nfbox@S@ul
    \global\let\curr@nfbox@S@lc\curr@nfbox@S@ll
    \global\let\curr@nfbox@T@uc\curr@nfbox@T@ul
  \else
    \global\let\curr@nfbox@S@uc\curr@nfbox@S@ur
    \global\let\curr@nfbox@S@lc\curr@nfbox@S@lr
    \global\let\curr@nfbox@T@uc\curr@nfbox@T@ur
  \fi
  \let \par \@@par
%    \end{macrocode}
%    \begin{macrocode}
%
% There are several possibilities when we start the output routine for
% a single column in a two-column layout.
% \begin{enumerate}
% \item Wide or big non-floats completely cover the page.  In this
% case we do not need to create columns, and directly go to the
% output.
% \item The columnd is occupied by tall or single nonfloats.  We make
% a column of nonfloats and send it further.
% \item There is room for text on the page, but its height
% (\cs{@colroom}) is different from the one known to the page builder
% (\cs{vsize}).  In this case we change \cs{vsize} and return.
% \item The room for text is exactly \cs{vsize}.  In this case we form
% a column and return.
% \end{enumerate}
%    \begin{macrocode}
  \global\@colht=\textheight
  \ifdim\ht\curr@nfbox@B@ul>0.5\baselineskip
    \global\advance\@colht by -\textheight
  \fi
  \ifdim\ht\curr@nfbox@W@ul>0.5\baselineskip
    \global\advance\@colht by -0.5\textheight
  \fi
  \ifdim\ht\curr@nfbox@W@ll>0.5\baselineskip
    \global\advance\@colht by -0.5\textheight
  \fi
  \ifdim\@colht < \baselineskip
    \nf@output@widepage
  \else
    \nf@makecol
  \fi
}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@output@widepage}
%   The macro \cs{nf@output@widepage} outputs a page completely filled
%   by wide pictures.
%    \begin{macrocode}
\def\nf@output@widepage{%
  \unvbox\@cclv
  \penalty\outputpenalty
  \if@firstcolumn\else
  \ClassError{faosyb}{Wide or big nonfloats defined too late.  Move
    them up}{I encountered Big or Wide floats when I already made the
    first column.  Please move them up}
  \fi
  \ifdim\ht\curr@nfbox@B@ul>0.5\baselineskip
     \setbox\@tempboxa\vsplit\curr@nfbox@B@ul to \textheight
     \setbox\@outputbox \vbox\bgroup
     \boxmaxdepth \@maxdepth
     \box\@tempboxa
     \vfill
     \egroup
  \else
     \setbox\@tempboxa\vsplit\curr@nfbox@W@ul to 0.5\textheight
     \setbox\@tempboxb\vsplit\curr@nfbox@W@ll to 0.5\textheight
     \setbox\@outputbox\vbox\bgroup
        \boxmaxdepth \@maxdepth
        \box\@tempboxa
        \nointerlineskip
        \box\@tempboxb
        \vfill
     \egroup
  \fi
  \global\vsize\textheight
  \global\@colht\textheight
  \@outputpage
  \@firstcolumntrue
}
%    \end{macrocode}
%   
% \end{macro}
%
%
% \begin{macro}{\nf@makecol}
%   This macro tries to make one column of text.  If successful, it
%   puts first column into temporary storage, and outputs the page
%   when or if the second column is ready.
%
%   When we start \cs{nf@makecol}, \cs{@colht} already reflects
%   possible wide nonfloats.  This to get \cs{@colroom}, we need to
%   take into account only the narrow ones
%    \begin{macrocode}
\def\nf@makecol{%
  \global\@colroom\@colht
  \ifdim\ht\curr@nfbox@T@uc>0.5\baselineskip
     \global\@colroom=0pt
  \fi
  \ifdim\ht\curr@nfbox@S@uc>0.5\baselineskip
     \global\advance\@colroom by -0.5\textheight
  \fi
  \ifdim\ht\curr@nfbox@S@lc>0.5\baselineskip
     \global\advance\@colroom by -0.5\textheight
  \fi
%    \end{macrocode}
%
%  Now there could be two cases.  If \cs{@colroom} is small, we fill
%  the column with the non-floats only.  Otherwise we have a ``mixed''
%  column with both text and nonfloats.
%    \begin{macrocode}
  \ifdim\@colroom<0.5\baselineskip
    \nf@makenfcol
  \else
    \nf@makemixedcol
  \fi}
%    \end{macrocode}
%   
% \end{macro}
%
%
% \begin{macro}{\nf@makenfcol}
%   This macro outputs a column with only non-floats.  If it is
%   called, we already know that the narrow non-floats would fill the
%   column, so we do not do any additional checks.
%    \begin{macrocode}
\def\nf@makenfcol{%
  \unvbox\@cclv
  \penalty\outputpenalty
  \ifdim\@colht>0.9\textheight  % one tall or two squares
    \ifdim\ht\curr@nfbox@T@uc>0.5\baselineskip
      \setbox\@outputbox\vbox\bgroup
      \boxmaxdepth \@maxdepth
      \vsplit \curr@nfbox@T@uc to \textheight
      \egroup
    \else
     \setbox\@outputbox\vbox\bgroup
      \boxmaxdepth \@maxdepth
      \vsplit\curr@nfbox@S@uc to 0.5\textheight
       \nointerlineskip
       \vsplit\curr@nfbox@S@lc to 0.5\textheight
     \egroup
    \fi
  \else  % one square
    \ifdim\ht\curr@nfbox@S@uc>0.49\textheight
      \setbox\@outputbox\vsplit \curr@nfbox@S@uc to 0.5\textheight
    \else
      \setbox\@outputbox\vsplit \curr@nfbox@S@lc to 0.5\textheight
    \fi
  \fi
  \nf@opcol
}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@makemixedcol}
%   This macros used when we have a mix of text with nonfloats (or
%   possibly just text).  
%
%   We check whether the page builder has the right idea about
%   the text size;  if not, we return from the output routine
%    \begin{macrocode}
\def\nf@makemixedcol{%
  \ifdim\@colroom=\vsize
    \nf@makemixedcol@
  \else
    \global\vsize=\@colroom
    \unvbox\@cclv
    \penalty\outputpenalty
  \fi}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@makmixedcol@}
%   And now the real work of \cs{nf@makemixedcol@}
%    \begin{macrocode}
\def\nf@makemixedcol@{%
   \ifvoid\footins
     \setbox\@outputbox \box \@cclv
   \else
     \setbox\@outputbox \vbox {%
       \boxmaxdepth \@maxdepth
       \unvbox \@cclv
       \vskip \skip\footins
       \color@begingroup
         \normalcolor
         \footnoterule
         \unvbox \footins
       \color@endgroup
       }%
   \fi
   \ifdim\ht\curr@nfbox@S@uc>0.49\textheight
     \setbox\@tempboxa\vsplit\curr@nfbox@S@uc to 0.5\textheight
     \setbox\@outputbox \vbox 
       \bgroup
         \box\@tempboxa
         \nointerlineskip
         \box\@outputbox
       \egroup
   \fi
   \ifdim\ht\curr@nfbox@S@lc>0.49\textheight
     \setbox\@tempboxa\vsplit\curr@nfbox@S@lc to 0.5\textheight
     \setbox\@outputbox \vbox 
       \bgroup
         \box\@outputbox
         \nointerlineskip
         \box\@tempboxa
       \egroup
   \fi
   \nf@opcol}
%    \end{macrocode}
%   
% \end{macro}
%
%
% \begin{macro}{\nf@opcol}
% \changes{v1.3}{2013/12/16}{Typo corrected}
%   This is like the standard \LaTeX\ \cs{@outputdblcol}, but with the
%   treatment of wide nonfloats.
%    \begin{macrocode}
\def\nf@opcol{%
  \if@firstcolumn
    \global\@firstcolumnfalse
    \global\setbox\@leftcolumn\box\@outputbox
  \else
    \global\@firstcolumntrue
    \ifdim\ht\curr@nfbox@W@ul>0.5\baselineskip
      \setbox\@tempboxa\vsplit \curr@nfbox@W@ul to 0.5\textheight
    \else
      \setbox\@tempboxb\box\@tempboxa
    \fi
    \setbox\@outputbox \vbox\bgroup
      \box\@tempboxa
      \nointerlineskip
      \hb@xt@\textwidth {%
        \hb@xt@\columnwidth {%
          \box\@leftcolumn \hss}%
        \hfil
        {\normalcolor\vrule \@width\columnseprule}%
        \hfil
        \hb@xt@\columnwidth {%
          \box\@outputbox \hss}%
      }%
    \egroup
    \ifdim\ht\curr@nfbox@W@ll>0.5\baselineskip
      \setbox\@tempboxa\vsplit \curr@nfbox@W@ll to 0.5\textheight
      \setbox\@outputbox\vbox\bgroup
        \box\@outputbox
        \nointerlineskip
        \box\@tempboxa
      \egroup
    \fi
    \@outputpage
    \global\vsize\textheight
    \global\@colht\textheight
    \global\@colroom\textheight
   \fi}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\standard@clearpage}
%   The usual \cs{clearpage} flushes the floats.  We keep it in
%   \cs{standard@clearpage}
%    \begin{macrocode}
\let\standard@clearpage\clearpage
%    \end{macrocode}
%   
% \end{macro}
% 
% \begin{macro}{\clearpage}
%   Now we can define \cs{clearpage} to take care of the mode:
%    \begin{macrocode}
\def\clearpage{%
  \if@twocolumn
    \nf@clearpage
  \else
    \standard@clearpage
\fi}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\nf@totalheight}
%   The total height of all non-floats
%    \begin{macrocode}
\def\nf@totalheight{\dimexpr(%
  \ht\nfbox@S@UL+
  \ht\nfbox@S@UR+
  \ht\nfbox@S@LL+
  \ht\nfbox@S@LR+
  \ht\nfbox@T@UL+
  \ht\nfbox@T@UR+
  \ht\nfbox@W@UL+
  \ht\nfbox@W@LL+
  \ht\nfbox@B@UL+
  \ht\nfbox@S@ul+
  \ht\nfbox@S@ur+
  \ht\nfbox@S@ll+
  \ht\nfbox@S@lr+
  \ht\nfbox@T@ul+
  \ht\nfbox@T@ur+
  \ht\nfbox@W@ul+
  \ht\nfbox@W@ll+
  \ht\nfbox@B@ul)}
%    \end{macrocode}
%   
% \end{macro}
%
%
% \begin{macro}{\nf@clearpage}
%   We keep ejecting pages until get rid of nf stuff
%    \begin{macrocode}
 \def\nf@clearpage{%
  \write\m@ne{}%
  \if@firstcolumn
    \ifdim\dimexpr(\pagetotal+\nf@totalheight)>\baselineskip
    \leavevmode
     \null\vfill\newpage
     \null\vfill\newpage
    \fi
  \else
    \leavevmode
   \null\vfill\newpage
  \fi
  \ifdim\nf@totalheight>\baselineskip
  \nf@clearpage\fi
}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\clearspread}
%   This is like \cs{cleardoublepage}, but with the logic inverted:
%    \begin{macrocode}
\def\clearspread{\clearpage\ifodd\c@page
    \hbox{}\newpage\if@twocolumn\hbox{}\newpage\fi\fi\@firstcolumntrue}
%    \end{macrocode}
%   
% \end{macro}
%
% We need to clear everything at the end
%    \begin{macrocode}
\AtEndDocument{\if@twocolumn
  \ifdim\nf@totalheight>\baselineskip
  \null\vfill\clearpage\fi
\fi}
%    \end{macrocode}
% 
%
%
%\subsection{Sectioning}
%\label{sec:sectioning}
%
% \begin{macro}{\if@mainmatter}
%   This is used to check whether we are at main matter
%    \begin{macrocode}
\newif\if@mainmatter
%    \end{macrocode}
%   
% \end{macro}
% 
% \begin{macro}{\frontmatter}
% \changes{v1.3}{2013/12/16}{Deleted change in the pagenumbering}
% \changes{v1.4}{2013/12/17}{Added new geometry}
%   We want Arabic numbers for front matter:
%    \begin{macrocode}
\def\frontmatter{%
  \pagestyle{frontmatterpagestyle}%
  \onecolumn\@mainmatterfalse}
%    \end{macrocode}
%   
% \end{macro}
% \begin{macro}{\mainmatter}
% \changes{v1.3}{2013/12/16}{Deleted change in the pagenumbering}
%   We want Arabic numbers for main matter:
%    \begin{macrocode}
\def\mainmatter{\loadgeometry{standard}\onecolumn
  \@mainmattertrue}
%    \end{macrocode}
%   
% \end{macro}
% 
% \begin{macro}{\tocdepth}
%   Only sections and up are allowed in TOC:
%    \begin{macrocode}
\setcounter{tocdepth}{1}
%    \end{macrocode}   
% \end{macro}
% \begin{macro}{\secnumdepth}
%   Only the parts are numbered in out setup:
%    \begin{macrocode}
\setcounter{secnumdepth}{-1}
%    \end{macrocode}  
% \end{macro}
% \begin{macro}{\thepart}
%   And the parts are numbered using Arabic numbers:
%    \begin{macrocode}
\renewcommand \thepart {\@arabic\c@part}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\c@fao@partnum}
%   To draw the blobs in part color in the proper position, we need to
%   associate them with parts.   However, some parts are numbered,
%   some are not.  The macro |\fao@partnum| keeps the current part
%   number counted continuously from the beginning to end.
%    \begin{macrocode}
\newcounter{fao@partnum}
\setcounter{fao@partnum}{0}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\fao@currentpartnum}
%   The current value of |\fao@partnum| used in TOC:
%    \begin{macrocode}
\def\fao@currentpartnum{0}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\part}
%  The largest partition in the book
%    \begin{macrocode}
\renewcommand\part{%
  \secdef\@part\@spart}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\EndPartIntro}
% \changes{v0.2}{2013/12/10}{Deleted \cs{clearspread}}
% \changes{v0.3}{2013/12/11}{Restored \cs{clearspread}}
% \changes{v1.3}{2013/12/16}{Added \cs{normalcolor}}
% \changes{v1.4}{2013/12/17}{Added multicols}
%   This command switches off the  special formatting of part pages:
%    \begin{macrocode}
\def\EndPartIntro{\clearpage
\end{adjmulticols}\clearspread\twocolumn\normalcolor
  \pagestyle{standardpagestyle}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{iconfill}
% \changes{v0.2}{2013/12/10}{Rewrote}
% \changes{v1.0}{2013/12/13}{Rewrote}
% \changes{v1.1}{2013/12/14}{Rewrote}
% \changes{v1.4}{2013/12/17}{Added spaces}
%   Fill a line with the icons of increasing size.  The
%   parameters are the initial size, length of the strip and the intensity
%   of the background
%    \begin{macrocode}
\def\@maxpart{1}
\def\iconfill#1#2#3{%
  \expandafter\ifx\csname @icon@1\endcsname\relax\strut\else
  \@tempcnta=1
  \setbox\@tempboxa=\hbox{}%
  \loop
  \@tempdima=#1
  \setbox\@tempboxa=\hbox{\unhbox\@tempboxa
    \colored@icon@fg[width=\@tempdima]{\csname
      @icon@\the\@tempcnta\endcsname}{#3}\hspace{0.3\@tempdima}}%
  \advance\@tempcnta by 1\relax
  \ifnum\@tempcnta>\@maxpart\relax\@tempcnta=1\fi
  \ifdim\wd\@tempboxa>#2\else\repeat
  \unhbox\@tempboxa
  \fi}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\currenticonfill}
% \changes{v1.1}{2013/12/14}{Added macro}
% \changes{v1.4}{2013/12/17}{Added spaces}
%   Several iterations of the current icon with increasing sizes.  The
%   parameters are the initial size, length and the intensity of the
%   background. %
%    \begin{macrocode}
\def\currenticonfill#1#2#3{%
  \expandafter\ifx\csname @icon@\thepart\endcsname\relax\strut\else
  \setbox\@tempboxa=\hbox{}%
  \@tempdima=#1
  \loop
  \@tempdima=1.44\@tempdima
  \setbox\@tempboxa=\hbox{\unhbox\@tempboxa
    \colored@icon@fg[width=\@tempdima]{\csname
      @icon@\thepart\endcsname}{#3}\hspace{0.2\@tempdima}}%
  \ifdim\wd\@tempboxa>#2\else\repeat
  \unhbox\@tempboxa
  \fi}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\@part}
% \changes{v0.2}{2013/12/03}{Changed formatting}
% \changes{v1.3}{2013/12/14}{Changed the way the icons are displayed}
% \changes{v1.4}{2013/12/17}{Text is now black}
% \changes{v1.4}{2013/12/17}{Changed margins for intro}
% \changes{v1.4}{2013/12/17}{Changed pictures}
% \changes{v1.5}{2013/12/18}{Changed pictures}
%   This is the actual part making macro.
%    \begin{macrocode}
\def\@part[#1]#2{%
  \clearspread
  \onecolumn  
  \clearspread
  \selectcolor
  \selecticon
  \color{@bgcolor}%
  \rowcolors{2}{@bgcolor!10}{}%
  \pagestyle{partpagestyle}%
  \refstepcounter{part}%
  \addcontentsline{toc}{part}{\thepart\hspace{1em}#1}%
  \protected@write\@auxout{}%
  {\string\newicon{\thepart}{\currenticon}
    \string\gdef\string\@maxpart{\thepart}}%
  \def\@partpagepicture{%
    \put(-15,-500){\rotatebox{30}{%
      \iconfill{1.2cm}{0.4\textwidth}{20}%
      \currenticonfill{1.2cm}{0.6\textwidth}{20}}}%
    \put(40,-550){\rotatebox{30}{%
      \iconfill{1.2cm}{1.2\textwidth}{100}}}%
    \put(40,-600){\rotatebox{30}{%
      \iconfill{1.2cm}{1.2\textwidth}{20}}}%
}
  \markboth{#1}{#1}%
  \null
  \newpage
  \def\@partpagepicture{\put(160,-180){\rotatebox{30}{\iconfill{1.2cm}{13.5cm}{20}}}%
  \gdef\@partpagepicture{}}
  {\interlinepenalty \@M
    \vspace*{80\p@}
    \captionfamily
    \fontsize{240\p@}{240\p@}\selectfont\raggedright\thepart~%
    \parbox[b]{0.8\textwidth}{\fontsize{64\p@}{72\p@}\selectfont
      \raggedright\null#2\par}\par\vskip80\p@
  }\par\normalcolor
  \begin{adjmulticols}{1}{44mm}{0mm}}
%    \end{macrocode}
% \end{macro}
% 
% \begin{macro}{\@currentsymbol}
% \changes{2013/12/16}{Introduced macro}
% The symbol for the next unnumbered part
%    \begin{macrocode}
\define@choicekey*+{fao}{symbol}[\val\nr]%
{righttriangle,square,rightsemicircle}{%
  \ifcase\nr\relax
    \gdef\@currentsymbol{(0,0) -- (1ex,0) -- (1ex,1ex) -- cycle}%
  \or
   \gdef\@currentsymbol{(0,0) -- (1ex,0) -- (1ex,1ex) -- (0,1ex) --
     cycle}%
  \or
   \gdef\@currentsymbol{(0,0) arc[start angle=90, end angle=-90, x
     radius = 0.5ex, y radius = 0.5ex] -- cycle}%
   \fi
}{\ClassError{faosyb}{Bad symbol value \val}}
\faoset{symbol=square}
%    \end{macrocode}
% 
%   
% \end{macro}
%
% \begin{macro}{\@spart}
% \changes{1.3}{2013/12/16}{Rewrote}
% \changes{1.4}{2013/12/17}{Changed fonts}
%   Unnmumbered parts are only in the foreword
%    \begin{macrocode}
\def\@spart#1{%
  \cleardoublepage
  \loadgeometry{frontmatter}%
  \pagestyle{spartpagestyle}%
  \onecolumn  
  \selectcolor
  \selecticon
  \rowcolors{2}{@bgcolor!10}{}%
  \phantomsection
  \addcontentsline{toc}{spart}{\hspace{1em}#1}%
  \makebox[0pt]{%
       \raisebox{-\totalheight}%
       [0pt][0pt]{\rotatebox{90}{\fontsize{9mm}{9mm}\selectfont
           \captionfamily
           \tikz\fill[color=@bgcolor]\@currentsymbol;\space
           \color{gray}#1\strut}}%
     \hspace*{50pt}}\par\vspace*{-\baselineskip}%
 \vspace*{-\parskip}}
%    \end{macrocode}
%   
% \end{macro}
% 
%
% \begin{macro}{\sectionmark}
%   We do not want to have uppercase sections in the footers
%    \begin{macrocode}
\def\sectionmark#1{\markright{#1}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\section}
% \changes{v0.2}{2013/12/10}{Redefined}
%   New sections start on a recto page in one column mode and on a
%   verso page in two column mode
%    \begin{macrocode}
\renewcommand\section{\par\clearspread
  \@startsection {section}{1}{\z@}%
                                   {-1sp}%
                                   {2.3ex \@plus.2ex}%
                                   {\normalfont\Large\bfseries\raggedright
                                   \color{@bgcolor}}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\subsection}
% \changes{v1.3}{2013/12/16}{Redefined}
%   The subsection macro
%    \begin{macrocode}
\renewcommand\subsection{\@startsection{subsection}{2}{\z@}%
                                     {-1sp}%
                                     {1.5ex \@plus .2ex}%
                                     {\normalfont\large\bfseries\raggedright
                                     \color{@bgcolor}}}
%    \end{macrocode}
%   
% \end{macro}
%
%\subsection{Tables}
%\label{sec:tables}
%
% \begin{macro}{\tablepages}
%   Long tables at the end of a part
%    \begin{macrocode}
\newenvironment{tablepages}{\onecolumn
  \bgroup\narrowfamily\multicolsep=\z@
  \vspace*{-2cm}%
  \def\emph{\textsl}%
  \begin{adjmulticols}{1}{-1.3cm}{-1.3cm}\centering\normalcolor}%
  {\end{adjmulticols}\egroup}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\tablemph}
%   Some styles define \cs{tablemph} commands.  Here we supply a stub
%    \begin{macrocode}
\AtBeginDocument{\providecommand{\tablemph}[1]{\emph{#1}}}
%    \end{macrocode}
%   
% \end{macro}
%
%
% We define new column types for table headers:
%    \begin{macrocode}
\newcolumntype{d}[1]{D{.}{.}{#1}}
\newcolumntype{H}{>{\columncolor{@tableheadcolor}[1.01\tabcolsep][1.01\tabcolsep]}c}
%    \end{macrocode}
% 
% |P| columntype is much more complex.  Basically we want a centered
% entry with a parbox of the given width inside.:
%    \begin{macrocode}
\newcolumntype{P}[1]{>{\columncolor{@tableheadcolor}[1.01\tabcolsep][1.01\tabcolsep]%
    \@fao@Pentry{#1}}c<{\end@fao@Pentry}}
%    \end{macrocode}
% \begin{macro}{\@fao@Pentry}
%   Since |\parbox| needs ``real'' braces to delimit the argument, 
%   we use this trick.  Note |\hspace{0pt}| to allow \TeX{} to
%   hyphenate the first word. 
%    \begin{macrocode}
\def\@fao@Pentry#1#2\end@fao@Pentry{%
\parbox[t]{#1}{\centering\strut\hspace{\z@}#2\strut}}
%    \end{macrocode}
%   
% \end{macro}
%
% Same with |C| entry:
%    \begin{macrocode}
\newcolumntype{C}[1]{>{\columncolor{@tableheadcolor}[1.01\tabcolsep][1.01\tabcolsep]%
    \@fao@Centry{#1}}c<{\end@fao@Centry}}
%    \end{macrocode}
% \begin{macro}{\@fao@Centry}
%   This macro is similar to |\@fao@Pentry|, but with different
%   way to set the width of the |\parbox|:
%    \begin{macrocode}
\def\@fao@Centry#1#2\end@fao@Centry{%
\settowidth{\@tempdima}{$-99.999$}%
\@tempdima=#1\@tempdima\relax
\parbox[t]{\@tempdima}{\centering\strut\hspace{\z@}#2\strut}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\LT@makecaption}
%   This macro produces the caption for the long tables.  We redefine
%   it to get the tables in the way specified by the designer
%    \begin{macrocode}
\def\LT@makecaption#1#2#3{%
  \LT@mcol\LT@cols {@{}l}{\cellcolor{white}%
    \rlap{\fcolorbox{white}{@tableheadcolor}{\normalsize
      \captionfamily\large\strut
      \textcolor{white}{#1{\MakeUppercase{#2}: }#3}}}%
    \begin{picture}(0,0)%
      \put(.5,-7){\color{@bgcolor}%
        \begin{tikzpicture}[baseline=(current bounding box.north)]
          \fill (0,0) -- (\nf@trianglebase,0) -- 
          (.5\nf@trianglebase,-\nf@trianglebase) -- cycle;
        \end{tikzpicture}}
    \end{picture}\normalcolor
    \raisebox{-17pt}{\strut}}}
%    \end{macrocode}
%   
% \end{macro}
% 
%
%\subsection{Front Matter}
%\label{sec:frontmatter}
%
% \begin{macro}{\@generictoc}
% \changes{v0.3}{2012/12/11}{Added macro}
% \changes{v1.4}{2012/12/17}{Added geometry change}
%   This is a generic macro with two parameters: name of the toc and
%   file extension
%    \begin{macrocode}
\def\@generictoc#1#2{\clearpage\loadgeometry{standard}%
  \pagestyle{frontmatterpagestyle}\onecolumn
  {\fontsize{48pt}{48pt}\selectfont
    \captionfamily\color{black!40}#1\par}\@mkboth{#1}{#1}\bigskip
  \@starttoc{#2}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\tableofcontents}
% \changes{v0.3}{2012/12/11}{Added macro}
% \changes{v1.3}{2012/12/11}{Rewrote}
% \changes{v1.4}{2012/12/17}{Added geometry change}
%   Our table of contents
%    \begin{macrocode}
\renewcommand\tableofcontents{\clearpage\loadgeometry{standard}%
  \pagestyle{frontmatterpagestyle}\onecolumn
  \@mkboth{\contentsname}{\contentsname}%
  \makebox[0pt][l]{\fontsize{24pt}{32pt}\selectfont \bfseries
    \color{black!70}\MakeUppercase{\contentsname}\space}%
  \par\vspace{-2\baselineskip}\vspace{-\parskip}%
  \@starttoc{toc}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\@tocpartskip}
%   This is the skip between the parts in TOC:
%    \begin{macrocode}
\newlength{\@tocpartskip}
\define@key{fao}{tocpartskip}{\setlength{\@tocpartskip}{#1}}
\faoset{tocpartskip=\z@}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\@fao@tocrule@start}
%   The start of the current TOC colored rule
%    \begin{macrocode}
\newdimen\@fao@tocrule@start
%    \end{macrocode}
%   
% \end{macro}
%
% 
% \begin{macro}{\@fao@tocrule@height}
%   The height of the current TOC rule
%    \begin{macrocode}
\newdimen\@fao@tocrule@height
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\@draw@tocrule@part}
%   Drawing the toc rule for a part
%    \begin{macrocode}
\def\@draw@tocrule@part{\@fao@tocrule@height=\pagetotal
  \protected@write\@auxout{}{\string\fao@partblobbottom{\fao@currentpartnum}{\the\@fao@tocrule@height}}%  
  \advance\@fao@tocrule@height-\@fao@tocrule@start
  \bgroup\parskip\z@
  \parbox[b][\z@]{\z@}{\hspace*{-15\p@}\color{@bgcolor}\rule{2\p@}{\@fao@tocrule@height}}%
  \parbox[b][\z@]{\z@}{\hspace*{330\p@}%
    \color{@bgcolor}\rule{41\p@}{\@fao@tocrule@height}}%
  \par\vspace{-0.5\baselineskip}\egroup}
%    \end{macrocode}
%   
% \end{macro}
%
%
% \begin{macro}{\@draw@tocrule@section}
%   Drawing the toc rule for a section
%    \begin{macrocode}
\def\@draw@tocrule@section{\@fao@tocrule@height=\pagetotal
  \protected@write\@auxout{}{\string\fao@partblobbottom{\fao@currentpartnum}{\the\@fao@tocrule@height}}%  
  \advance\@fao@tocrule@height-\@fao@tocrule@start
  \advance\@fao@tocrule@height5\p@
  \bgroup\parskip\z@\small
  \raisebox{\baselineskip}[\z@][\z@]{\parbox[b][\z@]{\z@}{\hspace*{-35\p@}\color{@bgcolor}\rule{2\p@}{\@fao@tocrule@height}}}%
  \raisebox{\baselineskip}[\z@][\z@]{\parbox[b][\z@]{\z@}{\hspace*{310\p@}%
      \color{@bgcolor}\rule{41\p@}{\@fao@tocrule@height}}}%
  \par\vspace{-\baselineskip}\egroup}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\l@part}
%   This prints the part in TOC:
%    \begin{macrocode}
\renewcommand*\l@part[2]{%
  \ifnum \c@tocdepth >-2\relax
    \addpenalty{-\@highpenalty}%
    \setlength\@tempdima{3em}%
    \addvspace{\@tocpartskip}%
    \begingroup
%    \end{macrocode}
% We store the current vertical position of the page into
% \cmd{\@fao@tocrule@start} 
%    \begin{macrocode}
%     \addvspace{-2pc}\par
     \@fao@tocrule@start=\pagetotal
     \protected@write\@auxout{}{\string\fao@partblobtop{\fao@currentpartnum}{\the\@fao@tocrule@start}}%
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leftskip180\p@
      {\leavevmode
       \color{@bgcolor}\bfseries\partname\space#1:
       \hfil \hb@xt@\@pnumwidth{\hss #2}}%
     \par\@draw@tocrule@part
       \nobreak
         \global\@nobreaktrue
         \everypar{\global\@nobreakfalse\everypar{}}%
    \endgroup
  \fi}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\l@spart}
%   This adds unnumbered part to TOC
%    \begin{macrocode}
\newcommand*\l@spart[2]{%
  \ifnum \c@tocdepth >-2\relax
    \addpenalty{-\@highpenalty}%
    \setlength\@tempdima{3em}%
    \begingroup
     \@fao@tocrule@start=\pagetotal
     \protected@write\@auxout{}{\string\fao@partblobtop{\fao@currentpartnum}{\the\@fao@tocrule@start}}%
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leftskip180\p@
      {\leavevmode
       \color{@bgcolor}\bfseries#1:
       \hfil \hb@xt@\@pnumwidth{\hss #2}}%
     \par\@draw@tocrule@part
       \nobreak
         \global\@nobreaktrue
         \everypar{\global\@nobreakfalse\everypar{}}%
    \endgroup
  \fi}
%    \end{macrocode}
% 
% \end{macro}
%
%
% \begin{macro}{\l@section}
%   This prints the section in TOC:
%    \begin{macrocode}
\renewcommand*\l@section[2]{%
  \ifnum \c@tocdepth >-2\relax
    \addpenalty{-\@highpenalty}%
    \setlength\@tempdima{3em}%
    \begingroup 
    \small
     \@fao@tocrule@start=\pagetotal
     \leftskip200\p@\relax\parskip\z@
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      {\leavevmode\small\strut
       #1\hfil \hb@xt@\@pnumwidth{\hss #2}}\par\@draw@tocrule@section
       \nobreak
         \global\@nobreaktrue
         \everypar{\global\@nobreakfalse\everypar{}}%
    \endgroup
  \fi}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\appendix}
%   We do not draw colored rules in the TOC part of the appendix:
%    \begin{macrocode}
\renewcommand\appendix{%
  \bookmarksetup{startatroot}%
  \addtocontents{toc}{\string\let\string\@draw@tocrule@part\string\relax
    \string\let\string\@draw@tocrule@section\string\relax}}
%    \end{macrocode}
%   
% \end{macro}
%
% 
% We use special formatting of metadata in the lists of\dots{} This
% requires explicit |\pars| at the end:
%    \begin{macrocode}
\AtEndDocument{%
  \immediate\write\@auxout{\string\@writefile{loc}{\string\par}}%
  \immediate\write\@auxout{\string\@writefile{lot}{\string\par}}%
  \immediate\write\@auxout{\string\@writefile{lom}{\string\par}}}
%    \end{macrocode}
% 
% \begin{macro}{\nf@dottedtocline}
% \changes{v1.4}{2013/12/17}{Introduced macro}
%   This is like the standard \cs{@dottedtocline}, but with colored
%   page numbers
%    \begin{macrocode}
\def\nf@dottedtocline#1#2#3#4#5{%
  \ifnum #1>\c@tocdepth \else
    \vskip \z@ \@plus.2\p@
    {\leftskip #2\relax \rightskip \@tocrmarg \parfillskip -\rightskip
     \parindent #2\relax\@afterindenttrue
     \interlinepenalty\@M
     \leavevmode
     \@tempdima #3\relax
     \advance\leftskip \@tempdima \null\nobreak\hskip -\leftskip
     {#4}\nobreak
     \leaders\hbox{$\m@th
        \mkern \@dotsep mu\hbox{.}\mkern \@dotsep
        mu$}\hfill
     \nobreak
     \hb@xt@\@pnumwidth{\hfil\normalfont\color{@bgcolor}#5}%
     \par}%
  \fi}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\l@nonfloat}
% \changes{v0.3}{2012/12/11}{Added macro}
% \changes{v1.4}{2012/12/17}{Made pagenumbers colored}
%   The generic listing of a nonfloat in a list
%    \begin{macrocode}
\newcommand*\l@nonfloat{\nf@dottedtocline{1}{\z@}{2.3em}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\numberline}
% \changes{v0.3}{2012/12/11}{Added macro}
%   The number in table of contents
%    \begin{macrocode}
\def\numberline#1{%
  \raisebox{\z@}[\z@][\z@]{%
    \fcolorbox{@bgcolor}{@bgcolor}{%
      \hb@xt@\@tempdima{\color{white}#1\strut\hfil}}}\hspace{2em}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\listofmaps}
% \changes{v0.3}{2012/12/11}{Added macro}
%   Our list of maps
%    \begin{macrocode}
\newcommand\listofmaps{\@generictoc{\listofmapsname}{lom}}
%    \end{macrocode}
% \end{macro}
% 
% \begin{macro}{\l@map}
% \changes{v0.3}{2012/12/11}{Added macro}
%   Entry in the list of maps
%    \begin{macrocode}
\let\l@map\l@nonfloat
%    \end{macrocode}
%   
% \end{macro}
% 
% \begin{macro}{\listoftables}
% \changes{v0.3}{2012/12/11}{Added macro}
%   Our list of tables
%    \begin{macrocode}
\renewcommand\listoftables{\@generictoc{\listtablename}{lot}}
%    \end{macrocode}
%   
% \end{macro}
% \begin{macro}{\l@table}
% \changes{v0.3}{2012/12/11}{Added macro}
%   Entry in the list of tables
%    \begin{macrocode}
\let\l@table\l@nonfloat
%    \end{macrocode}
%   
% \end{macro}
%
%
% \begin{macro}{\listofcharts}
% \changes{v0.3}{2012/12/11}{Added macro}
%   Our list of charts
%    \begin{macrocode}
\newcommand\listofcharts{\@generictoc{\listofchartsname}{loc}}
%    \end{macrocode}
% \end{macro}
% 
% \begin{macro}{\l@chart}
% \changes{v0.3}{2012/12/11}{Added macro}
%   Entry in the list of charts
%    \begin{macrocode}
\let\l@chart\l@nonfloat
%    \end{macrocode}
%   
% \end{macro}
%
%\subsection{Metadata}
%\label{sec:metadata}
% \changes{v1.3}{2013/12/14}{Added metadata from the old code}
%
% \begin{macro}{\metadatasection}
% \changes{v1.3}{2013/12/14}{Added macro}
%   The section for metadata:
%    \begin{macrocode}
\newcommand\metadatasection[1]{\clearspread\twocolumn\normalcolor
  \section{#1}} 
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{@indicatorsquarecolor}
% \changes{v1.5}{2013/12/18}{Added macro}
%   The color for the little squares in the indicator section
%    \begin{macrocode}
\define@key{fao}{indicatorsquarecolor}{%
  \colorlet{@indicatorsquarecolor}[cmyk]{#1}}
\faoset{indicatorsquarecolor=gray}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\metadata}
% \changes{v1.3}{2013/12/14}{Rewrote}
% \changes{v1.5}{2013/12/18}{Added vertical bars and squares}
% \changes{v1.6}{2013/12/18}{Made source, owner and refs bold}
%   This starts the metadata section.  The commands inside are local
%   to the metadata.
%    \begin{macrocode}
\def\metadata#1{\bgroup
      \def\meta@key{@@@@}%
%    \end{macrocode}
% Now we define the commands for metadata:
% \begin{macro}{\key}
%   This sets the key:
%    \begin{macrocode}
    \def\key##1{\NR@gettitle{##1}\phantomsection\label{##1}%
      \gdef\meta@key{##1}}
%    \end{macrocode}
% \end{macro}
% \begin{macro}{\source}
%   This typesets the source:
%    \begin{macrocode}
    \def\source##1{\textbar\,\emph{\bfseries Source: }##1. }%
%    \end{macrocode}   
% \end{macro}
% \begin{macro}{\owner}
%   This typesets the owner:
%    \begin{macrocode}
    \def\owner##1{\textbar\,\emph{\bfseries Owner: }##1. }%
%    \end{macrocode}   
% \end{macro}
%
%
%     \begin{macrocode}
  \begin{list}{}{\topsep8\p@\labelwidth\z@
      \labelsep\z@\itemindent\z@\parsep0.4ex plus 0.5ex minus
      0.2ex\relax\listparindent\z@\leftmargin\z@\rightmargin\z@
    \partopsep\z@}%
  \item{\bfseries{\color{@indicatorsquarecolor}$\blacksquare$}~#1\par\penalty10000}}      
%    \end{macrocode}
% \end{macro}
% \begin{macro}{\endmetadata}
%   This closes the environment:
%    \begin{macrocode}
\def\endmetadata{%
  \expandafter\ifx\csname
     metaback@\meta@key\endcsname\relax
  \else
    \textbar\,\emph{\bfseries Referenced in: }
    \csname metaback@\meta@key\endcsname
  \fi
  \end{list}\egroup}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\refMetadata}
%   The way we actually reference the metadata:
%    \begin{macrocode}
\def\refMetadata#1{%
  \ifx\@captype\@undefined\def\@captype{table}\fi
    \if@filesw
      \immediate\write\@mainaux{%
        \string\fao@metaback{#1}{\@captype}{\csname the\@captype\endcsname}{\thepage}{\@currentHref}}%
    \fi
}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\fao@metaback}
%   This reads the backreferences to metadata and prepares the the
%   list.  The arguments are: key, float type, number of float, page
%   and hyperref
%    \begin{macrocode}
\def\fao@metaback#1#2#3#4#5{%
  \expandafter\ifx\csname metaback@#1\endcsname\relax
    \expandafter\gdef\csname metaback@#1\endcsname{%
    \hyper@linkstart{link}{#5}#2~#3\hyper@linkend}%
  \else
    \expandafter\g@addto@macro\csname metaback@#1\endcsname{, 
    \hyper@linkstart{link}{#5}#2~#3\hyper@linkend}%
  \fi}
%    \end{macrocode}
%   
% \end{macro}
%
%
%
%\subsection{Further Reading}
%\label{sec:freading}
%
% \changes{v1.3}{2013/12/14}{Added Further Reading from the old code}
%
% \begin{macro}{\fitemize}
%   This is the special version of |itemize| for further reading
%   pages.  Basically it is a patched kernel version.
%    \begin{macrocode}
\def\fitemize{%
  \ifnum \@itemdepth >\thr@@\@toodeep\else
    \advance\@itemdepth\@ne
    \edef\@itemitem{labelitem\romannumeral\the\@itemdepth}%
    \expandafter
    \list
      \csname\@itemitem\endcsname
      {\def\makelabel##1{{##1}\space}\parskip\z@\topsep\z@
        \itemsep\z@\labelwidth\z@\parsep\z@\partopsep\z@
        \leftmargin\z@\labelsep\z@}%
  \fi}
%    \end{macrocode}
% \end{macro}
% \begin{macro}{\endfitemize}
%   This is standard:
%    \begin{macrocode}
\let\endfitemize =\endlist
%    \end{macrocode}
%   
% \end{macro}
% 
%
% \begin{macro}{\freading}
%   This is the ``Further Reading environment''
%    \begin{macrocode}
\newenvironment{freading}{%
  \bgroup
  \fboxsep=5\p@
  \let\itemize=\fitemize
  \let\enditemize=\endfitemize  
  \setbox\@tempboxa=\hbox\bgroup
  \begin{minipage}{0.9\columnwidth}\parskip\z@
  {\color{@bgcolor}\bfseries 
    \makebox[\z@][r]{%
      \tikz\fill[color=@bgcolor] (0,0) -- (1.5ex,0) -- (1.5ex, 1.5ex) --
      cycle;\hspace{5\p@}}%
    Further reading\strut\par}}{\end{minipage}\egroup
  \par\vspace{12mm}%
  \hspace{\dimexpr(0.1\columnwidth-10\p@)}%
  \fcolorbox{@bgcolor!10}{@bgcolor!10}{\box\@tempboxa}%
  \egroup}
%    \end{macrocode}
%   
% \end{macro}
% 
%   
% 
%
%\subsection{Publications}
%\label{sec:publications}
%
% \changes{v1.3}{2013/12/14}{Added Pubs from the old code}
%
% \begin{macro}{\@publicationskip}
%   Skip between the publications.  By default \cmd{\medskip}:
%    \begin{macrocode}
\newlength{\@publicationskip}
\define@key{fao}{publicationskip}{\setlength{\@publicationskip}{#1}}
\faoset{publicationskip=6pt plus 2pt minus 2pt}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@publicationparskip}
%   Paragraph skip between the publications.
%    \begin{macrocode}
\newlength{\@publicationparskip}
\define@key{fao}{publicationparskip}{\setlength{\@publicationparskip}{#1}}
\faoset{publicationparskip=6pt plus 6pt minus 4pt}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\publication}
% \changes{v1.5}{2013/12/18}{Swapped picture and description}
% \changes{v1.6}{2013/12/19}{Rotated picture}
% \changes{v1.7}{2014/04/06}{Rotated picture}
%   This typesets one publication:
%    \begin{macrocode}
\newenvironment{publication}[2][]{%
  \gdef\@pub@cover{#1}%
  \par
  \raisebox{\dimexpr(\baselineskip-\totalheight)}[0pt]{%
  \ifx\@pub@cover\@empty\rule{0.35\columnwidth}{\z@}\else
    \includegraphics[width=0.35\columnwidth, angle=5, 
    origin=c]{\@pub@cover}\fi}
  \hspace{0.1\columnwidth}%
  \begin{minipage}[t]{0.49\columnwidth}%
    \setlength\parskip{\@publicationparskip}%
    {\bfseries\large\color{@bgcolor}#2\par}
    \long\def\pDescription##1{\par##1\par}%
    \def\pEdition##1##2{\par##1: ##2\par}%
    \def\pCycle##1{\par Publication cycle: ##1\par}%
    \def\pWeb##1{\par \raggedright Webpage: \url{##1}\par}}%
  {\end{minipage}%
  \par
  \vspace{\@publicationskip}}
%    \end{macrocode}
%   
% \end{macro}
%
% \begin{macro}{\@resourcesicon}
% \changes{v1.5}{2013/12/18 Introduced macro}
% The icon for resources
%    \begin{macrocode}
\define@key{fao}{resourcesicon}{\gdef\@resourcesicon{#1}}
\faoset{resourcesicon={}}
%    \end{macrocode}
% 
%   
% \end{macro}
%
% \begin{macro}{\@resourcesname}
% \changes{v1.5}{2013/12/18 Introduced macro}
% The icon for resources
%    \begin{macrocode}
\define@key{fao}{resourcesname}{\gdef\@resourcesname{#1}}
\faoset{resourcesname={Key Resources}}
%    \end{macrocode}
% 
%   
% \end{macro}
%
% \begin{macro}{\KeyResources}
% \changes{v1.5}{2013/12/18 Introduced macro}
%   Here we start resources section
%    \begin{macrocode}
\def\KeyResources{\clearpage\phantomsection
  \ifx\@resourcesicon\@empty\else
  \def\@partpagepicture{%
    \put(190,-36){\colored@icon[width=1.2cm]{\@resourcesicon}}%
    \gdef\@partpagepicture{}}
  \fi
  \addcontentsline{toc}{section}{\@resourcesname}%
  \ifx\@resourcesicon\@empty\else
  \hspace*{1.3cm}%
  \fi
  {\color{@bgcolor}\Large\bfseries\raggedright\@resourcesname\par
    \vspace{2.3ex \@plus.2ex}}}
%    \end{macrocode}
%   
% \end{macro}
%
%\subsection{Subscripts}
%\label{sec:subscripts}
%
% \begin{macro}{\textsubscript}
%   This follows standard \LaTeX:
%    \begin{macrocode}
\DeclareRobustCommand*\textsubscript[1]{%
  \@textsubscript{\selectfont#1}}
\def\@textsubscript#1{%
  {\m@th\ensuremath{_{\mbox{\fontsize\sf@size\z@#1}}}}}
%    \end{macrocode}
% 
% \end{macro}
%
%
%
%\subsection{LyX code}
%\label{sec:lyx}
% 
% \begin{macro}{\lyxlist}
% It seems Lyx wants this:
%    \begin{macrocode}
\newenvironment{lyxlist}[1]
{\begin{list}{}
{\settowidth{\labelwidth}{#1}
 \setlength{\leftmargin}{\labelwidth}
 \addtolength{\leftmargin}{\labelsep}
 \renewcommand{\makelabel}[1]{##1\hfil}}}
{\end{list}}
%    \end{macrocode}
%   
% \end{macro}
%
%
%\subsection{Bibliography}
%\label{sec:bibliography}
%
% \begin{macro}{\thebibliography}
% \changes{v1.5}{2013/12/18}{Added macro}
%   Our bibliography is a section rather than a chapter.
%    \begin{macrocode}
\renewenvironment{thebibliography}[1]
     {\section{\bibname}%
      \list{\@biblabel{\@arabic\c@enumiv}}%
           {\settowidth\labelwidth{\@biblabel{#1}}%
            \leftmargin\labelwidth
            \advance\leftmargin\labelsep
            \@openbib@code
            \usecounter{enumiv}%
            \let\p@enumiv\@empty
            \renewcommand\theenumiv{\@arabic\c@enumiv}}%
      \sloppy
      \clubpenalty4000
      \@clubpenalty \clubpenalty
      \widowpenalty4000%
      \sfcode`\.\@m}
     {\def\@noitemerr
       {\@latex@warning{Empty `thebibliography' environment}}%
      \endlist}
%    \end{macrocode}
%   
% \end{macro}
%
%
% \subsection{The final word}
%\label{sec:final}
%
%    \begin{macrocode}
\setbgcolor{gray}\selectcolor
\loadgeometry{standard}%
\pagestyle{empty}
\normalsize\normalfont
%</class>      
%    \end{macrocode}
%   
%
%
%\Finale
%\clearpage
%
%\PrintChanges
%\clearpage
%\PrintIndex
%
\endinput


